# 機能仕様書: macOS 互換性のための Docker ビルドユーザー設定

**Feature Branch**: `003-mixseek-core-modify-docker-user`
**作成日**: 2025-10-17
**ステータス**: Draft
**Input**: ユーザー説明: "@specs/004-modify-docker-user/assets/prompt.md こちらの対応内容を参照して対応開始してください。"

## 明確化

### セッション 2025-10-17

- Q: 環境変数のバリデーション戦略は？ → A: すべてのバリデーションを完全に削除 - Docker 実行時エラーに依存

## ユーザーシナリオとテスト

### ユーザーストーリー 1 - macOS で GID 競合なしに Docker イメージをビルド (優先度: P1)

macOS 上で作業する開発者が MixSeek-Core プロジェクトの Docker イメージをビルドする必要があります。現在、システムが自動的にログインユーザーの GID (macOS では 20) を使用するため、コンテナ内の既存グループと競合し、「GID '20' already exists」エラーが発生してビルドが失敗します。

**この優先度の理由**: これは macOS 開発者が Docker イメージをビルドすることを完全に妨げるブロッキング問題です。これを解決しなければ、macOS ユーザーは開発やデプロイメント活動に参加できません。

**独立したテスト**: macOS で `make -C dockerfiles/dev build` を実行し、GID 関連のエラーなくビルドが正常に完了することを検証することで完全にテスト可能です。これにより macOS ベースの開発が即座に可能になります。

**受け入れシナリオ**:

1. **前提**: デフォルトユーザー設定 (UID 502, GID 20) の macOS 開発者が、**実行**: カスタム環境変数を設定せずに `make build` を実行すると、**結果**: デフォルト値 (mixseek_core ユーザー、UID 1000、GID 1000) を使用してビルドが正常に完了する
2. **前提**: カスタム UID/GID 要件を持つ macOS 開発者が、**実行**: MIXSEEK_USERNAME、MIXSEEK_UID、MIXSEEK_GID 環境変数を設定すると、**結果**: ビルドはデフォルトではなくこれらのカスタム値を使用する

---

### ユーザーストーリー 2 - 環境間で一貫したビルドユーザー設定 (優先度: P2)

DevOps エンジニアは、異なるオペレーティングシステム (Linux、macOS、Windows) および CI/CD 環境間で、一貫したユーザー設定で Docker イメージがビルドされることを保証する必要があります。ユーザー設定は予測可能であり、どの開発者のマシンでビルドされたかに依存してはなりません。

**この優先度の理由**: 開発を完全にブロックするわけではありませんが、再現可能なビルドを保証し、チーム間でイメージを共有したり異なる環境にデプロイする際の権限関連の問題を防ぎます。

**独立したテスト**: 環境変数を設定した場合としない場合で複数のプラットフォームで同じイメージをビルドし、結果のコンテナユーザー設定が期待通りであることを検証することでテスト可能です。ビルドの一貫性を保証することで価値を提供します。

**受け入れシナリオ**:

1. **前提**: 環境変数が設定されていない、**実行**: 任意のプラットフォームでビルドすると、**結果**: 結果のコンテナは常に mixseek_core (UID 1000、GID 1000) を使用する
2. **前提**: カスタム環境変数が 2 つの異なるプラットフォームで同一に設定されている、**実行**: 各プラットフォームでビルドすると、**結果**: 両方の結果コンテナは同一のユーザー設定を持つ
3. **前提**: CI/CD パイプライン、**実行**: 環境変数がパイプラインで設定されている、**結果**: すべてのビルドが CI/CD 指定の値を一貫して使用する

---

### ユーザーストーリー 3 - 特殊要件のためのデフォルトユーザー設定の上書き (優先度: P3)

特定のセキュリティや組織要件を持つ開発者または運用チームメンバーが、インフラストラクチャの制約 (例: NFS マウント権限、企業の LDAP 統合) に合わせたカスタムユーザー ID で Docker イメージを作成する必要があります。

**この優先度の理由**: 一般的ではないが、特定のデプロイメントシナリオでは重要となる可能性がある専門的なユースケースに対応します。デフォルトのワークフローに複雑さを追加することなく柔軟性を提供します。

**独立したテスト**: カスタム MIXSEEK_USERNAME、MIXSEEK_UID、MIXSEEK_GID 値を設定し、イメージをビルドし、コンテナがこれらの正確な認証情報で実行されることを検証することでテスト可能です。専門的なデプロイメント要件に価値を提供します。

**受け入れシナリオ**:

1. **前提**: 環境変数がカスタム値に設定されている (例: USERNAME=custom_user、UID=5000、GID=5000)、**実行**: イメージをビルドすると、**結果**: 結果のコンテナはこれらのカスタム値を使用する
2. **前提**: 一部の変数のみが設定されている (例: MIXSEEK_UID のみ)、**実行**: イメージをビルドすると、**結果**: ビルドは提供された値を使用し、未設定の変数にはデフォルトを使用する

---

### エッジケース

- MIXSEEK_GID が既存のコンテナシステムグループと競合する値に設定されている場合 (例: root の 0、daemon の 1) は、Docker ビルド時にエラーが発生する
- 無効な UID/GID 値 (負の数、非数値、システム制限を超える値) が設定されている場合は、Docker ビルド時にエラーが発生する
- MIXSEEK_USERNAME に特殊文字が含まれているか、ユーザー名の長さ制限を超えている場合は、Docker ビルド時にエラーが発生する
- ビルドプロセスは、未定義の環境変数の場合はデフォルト値を使用し、空の環境変数の場合もデフォルト値を使用する
- 複数の開発者が異なる UID/GID 設定でビルドし、ボリュームやファイルを共有する場合は、ファイル所有権の不一致が発生する可能性がある

## 要件

### 機能要件

- **FR-001**: システムは、コンテナユーザー名を指定するためのオプションの環境変数として MIXSEEK_USERNAME を受け入れなければならない
- **FR-002**: システムは、コンテナユーザー ID を指定するためのオプションの環境変数として MIXSEEK_UID を受け入れなければならない
- **FR-003**: システムは、コンテナグループ ID を指定するためのオプションの環境変数として MIXSEEK_GID を受け入れなければならない
- **FR-004**: システムは、環境変数が設定されていない場合、デフォルト値 (MIXSEEK_USERNAME=mixseek_core、MIXSEEK_UID=1000、MIXSEEK_GID=1000) を使用しなければならない
- **FR-005**: システムは、コンテナユーザー設定にログインユーザーの ID (whoami、id -u、id -g) を自動的に使用してはならない
- **FR-006**: ビルド検証ターゲット (validate-build-args) は、ビルド前に MIXSEEK_USERNAME、MIXSEEK_UID、MIXSEEK_GID の解決された値を表示しなければならない
- **FR-007**: ドキュメントは、さまざまなユースケースでカスタム環境変数を設定する方法を明確に説明しなければならない

### 主要エンティティ

- **ビルド環境設定**: Docker イメージビルドパラメータを制御する環境変数 (MIXSEEK_USERNAME、MIXSEEK_UID、MIXSEEK_GID) のセットを表します。これらの変数は、開発者ごと、環境ごと、またはデプロイメントシナリオごとに設定できます。

- **コンテナユーザー ID**: Docker コンテナ内に作成されるユーザーアカウントを表し、ユーザー名、UID、GID で定義されます。この ID は、コンテナ内のファイル所有権とプロセス権限を決定します。

## 成功基準

### 測定可能な成果

- **SC-001**: macOS 開発者が GID 競合エラーに遭遇することなく Docker イメージを正常にビルドできる
- **SC-002**: 開発者が環境変数を設定せずにイメージをビルドでき、予測可能なデフォルトユーザー設定の動作するコンテナを受け取る
- **SC-003**: Linux、macOS、CI/CD 環境全体で、同じ環境変数設定を使用した場合、100% のビルドが一貫したユーザー設定のコンテナを生成する
- **SC-004**: ビルド検証が各ビルド前に明確なユーザー設定情報を表示し、設定関連のサポートリクエストを少なくとも 60% 削減する
