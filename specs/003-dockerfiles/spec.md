# 機能仕様書: Docker開発環境テンプレート

**フィーチャーブランチ**: `003-mixseek-core-dockerfiles`
**作成日**: 2025-10-15
**ステータス**: ドラフト
**入力**: ユーザー記述: "dockerfiles.sample/spec.md の内容を確認し、要件・仕様を定義してください、必要に応じて dockerfiles.sample の構成を参考してください"

## 明確化

### セッション 2025-10-15

- Q: CI/本番環境でのPythonツールチェーンの範囲 → A: CI環境では基本Python開発ツール（pytest、ruff、coverage）のみ、本番環境ではランタイム依存関係のみ
- Q: コンテナリソース制限の戦略 → A: 全環境でリソース制限なし（ホストリソースに依存）
- Q: 環境変数テンプレートの構成戦略 → A: 環境別専用テンプレート（.env.dev.template等）
- 追加要件: 開発環境のみNode.jsとAI開発ツール（Claude Code、Codex、Gemini CLI）を含む
- Q: 環境変数テンプレートの構成方法 → A: 環境ごとに単一のフラットなテンプレートファイルにすべての環境変数を記載
- Q: 開発環境での認証情報管理戦略 → A: 開発環境ではサンドボックス/開発用認証情報、本番用認証情報は別途セキュア管理
- Q: GCPサービスアカウントファイル管理方法 → A: サービスアカウントファイルをホストからセキュアにマウントし、開発環境でのみ使用
- Q: AIサービスプロバイダー設定戦略 → A: 複数のAIプロバイダーをサポートし、プライマリとフォールバック設定を明確に定義、コスト管理オプション付き
- Q: ログレベル設定戦略 → A: 開発環境はDEBUG、CI環境はINFO、本番環境はWARN/ERRORレベルに設定し、環境別にログ出力先を最適化

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー1 - 標準化された開発環境のセットアップ (優先度: P1)

開発者は、mixseek-coreプロジェクトの一貫した再現可能な開発環境を迅速にセットアップし、本番環境と一致させ、「私のマシンでは動く」問題を解決する必要がある。

**この優先度の理由**: これはすべての開発作業の基盤となる。信頼性の高い開発環境がなければ、開発者はプロジェクトに効果的に貢献できない。

**独立テスト**: 新しい開発者がリポジトリをチェックアウトし、10分以内に開発コンテナの構築と実行を成功させ、その後テストとコード品質チェックを実行することで完全にテストできる。

**受け入れシナリオ**:

1. **前提** 新しいリポジトリチェックアウト、**実行時** 開発者がdockerfiles/devで`make build`を実行、**結果** 開発コンテナがエラーなしで正常に構築される
2. **前提** 構築済みの開発コンテナ、**実行時** 開発者が`make run`を実行、**結果** すべての依存関係がインストールされ開発準備が完了した状態でコンテナが起動する
3. **前提** 実行中の開発コンテナ、**実行時** 開発者が`make bash`で接続、**結果** Pythonコードの実行、テストの実行、すべての開発ツールへのアクセスが可能

---

### ユーザーストーリー2 - セキュアな設定管理 (優先度: P1)

開発者は、バージョン管理で機密情報を公開せずに、異なる環境（開発、テスト、本番）の環境変数と認証情報を安全に管理する必要がある。

**この優先度の理由**: 認証情報の公開によるセキュリティ脆弱性は、深刻なビジネス影響と規制コンプライアンス問題を引き起こす可能性がある。

**独立テスト**: 機密認証情報がバージョン管理にコミットされておらず、環境設定テンプレートが適切に構造化されていることを確認することでテストできる。

**受け入れシナリオ**:

1. **前提** 環境テンプレートが存在、**実行時** 開発者がテンプレートをローカル設定にコピー、**結果** gitでシークレットを公開せずに環境を設定できる
2. **前提** 環境設定、**実行時** コンテナが起動、**結果** Dockerfileにハードコーディングされた認証情報なしで環境変数を安全に読み込む
3. **前提** 異なる環境タイプ、**実行時** 環境間の切り替え、**結果** 適切な設定が自動的に適用される

---

### ユーザーストーリー3 - 多環境サポート (優先度: P2)

開発チームは、一貫性を保ちながら環境固有の最適化と設定を持つ、異なる環境タイプ（開発、CI/CD、本番）のサポートが必要。

**この優先度の理由**: 異なる環境はセキュリティ、パフォーマンス、ツールに対して異なる要件を持つが、一貫性を保つことでデプロイメント問題を防ぐ。

**独立テスト**: 異なる環境のコンテナを適切な設定で正常に構築・実行し、環境固有の動作を検証することでテストできる。

**受け入れシナリオ**:

1. **前提** 異なる環境ディレクトリ、**実行時** 環境固有のコンテナを構築、**結果** 各環境が適切なツールと設定を含む
2. **前提** CI環境、**実行時** テストを実行、**結果** 開発デバッグツールなしでテストレポートとカバレッジツールを含む環境
3. **前提** 本番環境設定、**実行時** コンテナをデプロイ、**結果** 開発ツールを除外し本番監視を含む環境

---

### ユーザーストーリー4 - 開発ワークフロー統合 (優先度: P2)

開発者は、コンテナ化された環境とシームレスに動作する一般的な開発タスク（テスト、リント、デバッグ、ビルド）の統合されたワークフローが必要。

**この優先度の理由**: 合理化されたワークフローは開発者の生産性を向上させ、チーム全体で一貫した開発プラクティスを確保する。

**独立テスト**: 各開発ワークフロータスクを独立して実行し、合理的な時間内で期待される結果を確認することでテストできる。

**受け入れシナリオ**:

1. **前提** 開発コンテナ、**実行時** `make unittest`を実行、**結果** すべてのテストが正常に実行され結果が明確に表示される
2. **前提** コード変更、**実行時** コード品質チェックを実行、**結果** リントとフォーマットツールがコードを分析し実用的なフィードバックを提供
3. **前提** デバッグセッションが必要、**実行時** デバッグモードを開始、**結果** リモートデバッグが正常に接続しブレークポイントの設定が可能

---

### エッジケース

- ホストシステムでDockerがインストールされていない、または実行されていない場合はどうなるか？
- ホストとコンテナのファイルシステム間で権限問題が発生した場合、システムはどのように処理するか？
- 環境変数ファイルが存在しないか、不正な形式の場合はどうなるか？
- 依存関係をダウンロードする際にネットワーク接続に問題がある場合、ビルドプロセスはどのように処理するか？
- ホストシステムのリソース（メモリ、ディスク容量）が不足している場合はどうなるか？

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはDockerコンテナを使用した再現可能な開発環境セットアップを提供しなければならない
- **FR-002**: システムは適切な設定で複数の環境タイプ（開発、テスト、本番）をサポートしなければならない
- **FR-003**: システムはバージョン管理でシークレットを公開せずに環境変数と認証情報を安全に管理しなければならない
- **FR-004**: システムはファイル所有権の問題を防ぐためにホストとコンテナのユーザー権限を同期しなければならない
- **FR-005**: システムはPython依存関係管理のためにuvパッケージマネージャーと統合しなければならない
- **FR-006**: システムはMakefileターゲットを通じて自動化されたビルドと実行ワークフローを提供しなければならない
- **FR-007**: システムは開発ツール統合（デバッグ、テスト、コード品質チェック）をサポートしなければならない
- **FR-008**: システムは開発環境でのみNode.jsランタイム環境を提供し、本番・CI環境では除外しなければならない
- **FR-009**: システムは開発環境でAI開発ツール（Claude Code、Codex、Gemini CLI）を一般ユーザー権限でインストールしなければならない
- **FR-010**: システムは環境タイプに応じた適切なツールチェーンを提供しなければならない（開発：フル機能、CI：基本Python開発ツール、本番：ランタイムのみ）
- **FR-011**: システムは各環境タイプ専用の単一フラット構造の環境変数テンプレートファイルを提供しなければならない（AWS、GCP、Snowflake、AIサービス等のすべての変数を含む）
- **FR-012**: システムはホットリロード機能付きの開発ワークフロー用ボリュームマウントを提供しなければならない
- **FR-013**: システムはコンテナリソース制限を設定せず、ホストリソースに依存する構成としなければならない
- **FR-014**: システムはセットアップと使用ワークフローの包括的なドキュメントを含まなければならない
- **FR-015**: システムは開発環境でサンドボックス/開発用認証情報を使用し、本番用認証情報は別途セキュアに管理しなければならない
- **FR-016**: システムはGCPサービスアカウントファイルをホストからセキュアにマウントし、開発環境でのみ使用可能としなければならない
- **FR-017**: システムは複数のAIサービスプロバイダー（OpenAI、Anthropic、Google Gemini）をサポートし、プライマリとフォールバック設定を明確に定義し、コスト管理オプションを提供しなければならない
- **FR-018**: システムは環境別のログレベル設定を提供しなければならない（開発：DEBUG、CI：INFO、本番：WARN/ERROR）

### 主要エンティティ *(データが関与する場合に含める)*

- **環境設定**: 変数定義、サービス設定、ランタイムパラメータを含む環境固有の設定を表す（単一フラット構造テンプレートファイルで管理、開発/本番で異なる認証情報）
- **コンテナイメージ**: インストールされた依存関係、設定されたランタイム環境、開発ツールを含む構築されたDockerイメージを表す（環境タイプにより異なるツールセット）
- **AI開発ツールセット**: Claude Code、Codex、Gemini CLIを含む、開発環境専用のAI支援ツール群を表す
- **ビルドコンテキスト**: 依存関係、ソースコード、ビルドアーティファクトを含むコンパイルとアセンブリプロセスを表す
- **開発ワークスペース**: ソースコード、設定ファイル、一時的なビルド出力を含むマウントされた開発ディレクトリを表す
- **GCPサービスアカウント**: ホストからセキュアにマウントされるGCPサービスアカウントファイル（開発環境専用、本番環境では他の認証方式を使用）
- **AIサービス設定**: 複数のAIプロバイダー（OpenAI、Anthropic、Gemini）の認証情報とプライマリ/フォールバック設定、コスト管理パラメータを含む

## 成功基準 *(必須)*

### 測定可能な結果

- **SC-001**: 新しい開発者は、リポジトリクローンから10分以内に完全な開発環境（AI開発ツール含む）をセットアップできる
- **SC-002**: コンテナビルドは標準的な開発ハードウェアで5分以内に正常に完了する
- **SC-003**: 開発ワークフロー（テスト実行、リント、デバッグ）はネイティブ実行と同等の期待される時間内に完了する
- **SC-004**: バージョン管理における認証情報や設定の公開に関連するセキュリティインシデントは発生しない
- **SC-005**: 95%の開発者が追加サポートを必要とせずに初期環境セットアップを成功させる
- **SC-006**: コンテナ環境は異なるホストオペレーティングシステム（Linux、macOS、Windows）間で一貫した動作を提供する
- **SC-007**: AI開発ツール（Claude Code、Codex、Gemini CLI）が開発環境で正常に動作し、本番・CI環境には含まれない
- **SC-008**: 各環境タイプで適切なツールセットのみがインストールされ、不要なツールは除外される
- **SC-009**: 環境変数テンプレートがフラット構造で全クラウドサービス認証情報を網羅し、開発/本番で適切に分離される
- **SC-010**: AIサービスプロバイダーのフォールバック機能が正常に動作し、コスト管理設定が適切に適用される
- **SC-011**: 各環境で適切なログレベルが設定され、ログ出力先が環境に応じて最適化される

## 前提条件

- Dockerエンジンが開発者のワークステーションで利用可能で適切に設定されている
- 開発者がDockerの概念とコマンドラインツールに基本的な知識を持っている
- ベースイメージと依存関係のダウンロードのためのネットワーク接続が利用可能
- ホストシステムが開発コンテナ実行のための十分なリソースを持っている（リソース制限は設定しない）
- Gitがバージョン管理操作のために適切に設定されている
- 各環境タイプ専用の環境変数テンプレートが本番の機密値とは別に維持される
- npmレジストリへのアクセスが可能でAI開発ツールのインストールができる
- 開発環境でGCPサービスアカウントファイルをホストからマウント可能
- AWS、Snowflake、AIサービス（OpenAI、Anthropic、Gemini）の開発用認証情報が利用可能
- 複数のAIプロバイダーサービスへのネットワークアクセスが可能