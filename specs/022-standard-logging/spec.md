# Feature Specification: Standard Logging and Logfire Spans Local Output Integration

**Feature Branch**: `157-standard-logging`
**Created**: 2025-11-26
**Status**: Draft
**Input**: User description: "ai_working/ddd/plan.mdの内容を仕様化 - Standard logging integration with Logfire and local output for both application logs and observability spans"

## ユーザーシナリオとテスト *（必須項目）*

### ユーザーストーリー1 - デフォルトのローカルログ出力機能（優先度：P1）

mixseekコマンドを実行する開発者として、追加の設定なしにアプリケーションログとオブザーバビリティトレースが自動的にコンソールとファイルの両方に出力されるようにしたい。これにより、実行状況を監視し、ローカル環境で問題をデバッグできるようにする。

**この優先度の理由**: これはシステムの中核的な価値提案である。開発者はシステムが現在どのような処理を行っているかをすぐに把握できる必要がある。ローカル出力がなければ、開発者は効果的にデバッグやワークフローの監視を行うことができない。

**独立テスト**: 任意のmixseekコマンドを実行し、出力がコンソール（stderr）とワークスペースのログディレクトリの両方に表示されることを確認することで完全にテスト可能。デバッグおよび監視のための即時価値を提供する。

**受け入れシナリオ**:

1. **前提条件**: ユーザーがデフォルト設定で `mixseek team "..."` コマンドを実行した場合、**実行時**にアプリケーションログメッセージがコンソールに表示されるとともに**ログファイルが作成される**こと

2. **前提条件**: ユーザーがログ出力フラグを指定せずに任意のmixseekコマンドを実行した場合、**エージェント実行時**にエージェント実行トレース（スパン）がコンソール出力に表示されるとともに**ログファイルに書き込まれる**こと

3. **前提条件**: `$MIXSEEK_WORKSPACE/logs/` ディレクトリが存在しない場合、**コマンド実行時**に自動的にログディレクトリが作成されること

---

### ユーザーストーリー2 - 特定の出力先を無効化する機能（優先度：P2）

CI/CD環境やバッチ処理システムで開発を行う際、コンソール出力やファイル出力を選択的に無効化できるようにしたい。これにより、運用状況に応じてログの出力先を柔軟に制御できるようになる。

**この機能の優先度が高い理由**: 本番環境とCI環境では、必要なログ出力の挙動が異なる場合が多いため。迅速なテスト時にはコンソール出力のみ、バックグラウンド処理時にはファイル出力のみといった使い分けが求められる。

**単体テスト方法**: `--no-log-console` または `--no-log-file` オプションを指定してコマンドを実行し、出力が残りの有効化された出力先にのみ表示されることを確認することでテスト可能。

**受け入れ基準シナリオ**:

1. **前提条件**: ユーザーが `mixseek team "..." --no-log-console` を実行した場合、**実行時**にログメッセージが生成されると、**結果**としてメッセージはログファイルにのみ表示され、コンソールには表示されない

2. **前提条件**: ユーザーが `mixseek team "..." --no-log-file` を実行した場合、**実行時**にログメッセージが生成されると、**結果**としてメッセージはコンソールにのみ表示され、ログファイルは作成または更新されない

3. **前提条件**: ユーザーが `mixseek team "..." --no-log-console --no-log-file` を実行した場合、**実行時**にログメッセージが生成されると、**結果**としてコンソールにもログファイルにもログが出力されない（サイレントモード）

---

### ユーザーストーリー 3 - ログ出力レベルの制御（優先度：P2）

開発者として問題をデバッグする際、必要に応じてログレベル（debug/info/warning/error）を柔軟に設定できるようにしたい。これにより、詳細な情報が必要な場合と、通常の運用時に不要な詳細を省略したい場合を使い分けられる。

**この優先度の理由**: debugレベルのログ出力はトラブルシューティングに不可欠ですが、通常運用時には過剰な情報量となります。ユーザーが効果的にデバッグ作業を行うためには、このような制御機能が必要です。

**独立テスト**: `--log-level debug` オプションを指定してコマンドを実行し、デフォルトのinfoレベルと比較してより詳細なメッセージが表示されることを確認することでテスト可能です。

**受け入れシナリオ**:

1. **前提条件**: ユーザーが `mixseek team "..." --log-level debug` コマンドを実行した場合、**実行時**にログメッセージが生成され、**結果**として DEBUG、INFO、WARNING、ERROR の各レベルのメッセージがすべて表示される

2. **前提条件**: ユーザーが `mixseek team "..." --log-level warning` コマンドを実行した場合、**実行時**にログメッセージが生成され、**結果**として WARNING および ERROR レベルのメッセージのみが表示される

3. **前提条件**: ユーザーがデフォルト設定でコマンドを実行した場合、**実行時**にログメッセージが生成され、**結果**として INFO、WARNING、ERROR レベルのメッセージが表示される（DEBUGレベルの情報は非表示）

---

### ユーザーストーリー4 - Logfireを利用したクラウドロギング（優先度：P3）

本番環境のワークロードを監視するチームリーダーとして、ローカル出力に加えてオプションでログをLogfireクラウドにも送信できるようにしたい。これにより、Logfireのダッシュボードを活用した一元的な可観測性を実現できる。

**この優先度の理由**：クラウドロギングは有用な機能ではあるが、必須ではない。まずローカル出力を優先することで、ユーザーはオフライン環境でも作業を継続できる。クラウド連携は機能拡張として位置付けられる。

**単体テスト**：`--logfire`フラグを指定して実行し、ログがローカル出力先に加えてLogfireダッシュボードにも表示されることを確認することでテスト可能である。

**受け入れシナリオ**：

1. **前提条件**：ユーザーが`mixseek team "..." --logfire`コマンドを実行した場合、**発生時**にログメッセージとスパンが生成されると、**結果**としてコンソール出力、ファイル出力、およびLogfireクラウドダッシュボードのすべてに表示されること

2. **前提条件**：ユーザーが`mixseek team "..."`コマンドを`--logfire`オプションなしで実行した場合、**発生時**にログメッセージが生成されても、**結果**としてLogfireクラウドには送信されないこと（デフォルトではクラウド機能は無効化されている）

---

### エッジケース

- ログディレクトリが読み取り専用の場合の動作：システムは明確なエラーメッセージを表示し、適切に処理を終了する必要がある。
- ログ記録中にディスク容量が不足した場合の動作：システムは書き込み失敗時にクラッシュせず、適切にエラーを処理する必要がある。
- 無効なログレベルが指定された場合の動作：システムは明確なエラーメッセージを表示し、有効なオプションの一覧を提示して処理を拒否する必要がある。
- コンソール出力とファイル出力の両方が無効で、かつ Logfire が有効になっていない場合の動作：サイレントモードはエラーなく正常に動作する必要がある。

### スコープ外

以下の機能は本仕様のスコープ外とし、将来の拡張として検討する：

- **ログローテーション**: サイズベースまたは日付ベースのログファイル分割。ユーザーは必要に応じて外部ツール（logrotate等）または手動でログファイルを管理する。
- **ログ圧縮**: 古いログファイルの自動圧縮。
- **ログ保持ポリシー**: 古いログファイルの自動削除。
- **出力先別ログレベル設定**: `--console-level`, `--file-level`, `--logfire-level` 等の出力先ごとに異なるログレベルを設定する機能。`--log-level` によるグローバル設定のみをサポートする。

## 必須要件 *（必須）*

### 機能要件

**経路1：標準ロギング統合**

- **FR-001**: システムは、有効化された出力先に標準ロギング呼び出し（info、debug、warning、error）を必ず転送しなければならない
- **FR-002**: システムは、標準エラーストリームを介したコンソール出力をサポートしなければならない
- **FR-003**: システムは、`$MIXSEEK_WORKSPACE/logs/mixseek.log` へのファイル出力をサポートしなければならない
- **FR-004**: システムは、デフォルトでコンソール出力とファイル出力の両方を有効にしなければならない（追加のフラグは不要）
- **FR-005**: システムは、`--no-log-console` フラグによってコンソール出力を無効化できるようにしなければならない
- **FR-006**: システムは、`--no-log-file` フラグによってファイル出力を無効化できるようにしなければならない
- **FR-007**: システムは、`--log-level` フラグを使用して全出力先のログレベルを制御できるようにしなければならない（設定可能な値：debug、info、warning、error）
- **FR-008**: システムは、ログレベルが指定されない場合、デフォルトで「info」レベルを全出力先に適用しなければならない

**経路2：可観測性スパンの出力**

- **FR-009**: システムは、有効化されたローカル出力先に Logfire の可観測性スパン（エージェント実行トレース）を出力しなければならない
- **FR-010**: システムは、複数の出力先（コンソールとファイル）への同時出力をサポートしなければならない
- **FR-011**: システムは、ログディレクトリが存在しない場合には自動的に作成しなければならない

**クラウド連携**

- **FR-012**: システムは、デフォルトで Logfire クラウドへの送信機能を無効化しなければならない
- **FR-013**: システムは、`--logfire` フラグが指定された場合に Logfire クラウドへの送信を有効にしなければならない
- **FR-014**: システムは、適切なフラグが設定されている場合、コンソール・ファイル・クラウドの3つの出力先すべてへの同時出力をサポートしなければならない

**設定機能**

- **FR-015**: システムは、以下の環境変数による設定をサポートしなければならない：
  - `MIXSEEK_LOG_LEVEL`: ログレベル（debug/info/warning/error）
  - `MIXSEEK_LOG_CONSOLE`: コンソール出力の有効化（true/false、デフォルト: true）
  - `MIXSEEK_LOG_FILE`: ファイル出力の有効化（true/false、デフォルト: true）
- **FR-016**: システムは、TOML形式の設定ファイルによる設定をサポートしなければならない
- **FR-017**: CLIフラグの設定は、環境変数およびTOML設定ファイルの設定よりも優先されなければならない

### Key Entities

- **LoggingConfig**: 標準ログの設定管理を行う。出力先、グローバルログレベル、ファイルパスなどの設定を管理する
- **Log Destination**: 出力先ターゲット（コンソール、ファイル、クラウドなど）を表し、それぞれに有効化状態が設定可能（ログレベルは全出力先で共通）
- **Log Message**: タイムスタンプ、発生元、ログレベル、メッセージ内容を含む構造化ログエントリ
- **Observability Span**: Logfireの計測機能によって収集されたエージェント実行時のトレース記録

## 成功基準 *（必須項目）*

### 測定可能な成果指標

- **SC-001**: 開発者は実行ログをコンソール上で生成後1秒以内に確認できる状態にする（リアルタイム可視化）
- **SC-002**: すべてのログメッセージを実行後に手動で設定することなくファイルに永続化される
- **SC-003**: ユーザーが単一のフラグ追加（`--logfire`）でクラウドログ機能を有効化できる
- **SC-004**: 既存の`mixseek`コマンドは修正なしで引き続き正常に動作する（100%の後方互換性を確保）
- **SC-005**: ログレベルのフィルタリングにより、表示される出力量が適切に削減される（例：警告レベルではデバッグレベルの約20%の出力量となる）
- **SC-006**: ユーザーはクラウド接続がなくてもオフライン環境で問題をデバッグ可能（ローカルファーストな可観測性を実現）

### 前提条件

- 作業ディレクトリ（`$MIXSEEK_WORKSPACE`）が設定されており、書き込み可能であること
- ログレベル（debug/info/warning/error）の基本的な概念を理解しているユーザー
- `--logfire` フラグを使用する場合、オプション依存関係である Logfire がインストールされていること
- ログファイルは追加モード（append mode）で使用され、コマンド実行間でのデータ保持が可能であること

### ログレベル設定

- `--log-level` フラグにより全出力先のログレベルを一括設定する（グローバル設定）
- デフォルト値: `info`
- 設定可能な値: `debug`, `info`, `warning`, `error`

## アーキテクチャ決定

### AD-001: LoggingConfig/LogfireConfigはConfigurationManagerとは独立して管理する

**決定**: ロギング設定（LoggingConfig、LogfireConfig）は、既存のConfigurationManager（specs/013-configuration）とは統合せず、独立したdataclassとして実装する。

**理由**:
1. **初期化順序**: ロギングはアプリケーション起動時に最初に初期化されるべきであり、ConfigurationManagerより先に必要
2. **循環参照の回避**: ConfigurationManager自体が`import logging`を使用しているため、ロギング設定をConfigurationManager経由にすると循環参照のリスクがある
3. **単純さの維持**: 現在のLogfireConfig（dataclass + from_env/from_toml）は十分シンプルでArticle 9にも準拠している
4. **FR-016/FR-017準拠**: 仕様は「環境変数」と「TOMLファイル」のサポートを要求しているが、ConfigurationManager経由を必須としていない

**実装方針**:
- LogfireConfig（既存）: dataclass維持、`from_env()`/`from_toml()`メソッド
- LoggingConfig（新規）: dataclass、`from_env()`/`from_toml()`メソッド
- 両設定はConfigurationManagerとは独立して初期化・管理される

## Clarifications

### Session 2025-11-26

- Q: LoggingConfig/LogfireConfigはConfigurationManagerに統合すべきか？ → A: 統合せず、独立を維持する（初期化順序・循環参照回避・単純さの観点から）
- Q: デフォルトログレベルの矛盾（FR-008 vs 前提条件）をどう解決するか？ → A: 全出力先で統一されたグローバルログレベル（デフォルト: info）を使用する（FR-008修正済み）
- Q: ログローテーションポリシーは必要か？ → A: スコープ外。初期リリースでは基本機能に集中し、ログローテーション・圧縮・保持ポリシーは将来の拡張として検討
- Q: 出力先別ログレベル設定（--console-level, --file-level, --logfire-level）は必要か？ → A: スコープ外。`--log-level`によるグローバル設定のみをサポートし、実装を簡素化する。ユーザーストーリー4（P3）を削除、FR-009を削除
- Q: 既存の--logfire, --logfire-metadata, --logfire-httpフラグとの互換性は必須か？ → A: 変更可。FR-019を削除し、CLIフラグの設計を柔軟にする
- Q: 環境変数の命名規則は？ → A: `MIXSEEK_LOG_*` プレフィックスを使用（`MIXSEEK_LOG_LEVEL`, `MIXSEEK_LOG_CONSOLE`, `MIXSEEK_LOG_FILE`）
- Q: Logfire関連の環境変数は？ → A: 既存の`LOGFIRE_*`環境変数を継続使用（`LOGFIRE_ENABLED`, `LOGFIRE_PRIVACY_MODE`等）。新規追加は不要
- Q: FR-018（後方互換性要件）は必要か？ → A: 不要。loggingの内部実装が変更されるだけで、既存コード（`logging.getLogger(__name__)`）は結果的に後方互換性が担保される。明示的なFR項目としては削除
