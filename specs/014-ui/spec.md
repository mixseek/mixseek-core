# 機能仕様書: Mixseek 実行・結果 UI

**Feature Branch**: `076-ui`  
**Created**: 2025-11-06  
**Status**: Draft  
**Input**: User description: "次のUIを設計するための仕様を定義してください 実行ページ(mixseek exec相当) - タスク(ユーザプロンプト)を入力 - タスクの実行 結果ページ - リーダーボード - 最高スコアのサブミッション - リーダーボードのチームをクリックすると、チームのサブミッションの詳細が表示 - スコアの推移(ラウンドコントローラ完成後、将来実装) 設定ページ - Member Agentの一覧、追加、変更、削除 - Leader Agentの一覧、追加、変更、削除 - オーケストレーションの一覧、追加、変更、削除"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー1 - タスクを実行する (Priority: P1)

MixSeekオペレーターとして、実行ページを開き、使用するオーケストレーション設定を選択し、タスクプロンプトを入力して実行したい。そうすることで、選択した設定でエージェントの応答をすぐに確認できる。

**この優先度の理由**: タスク実行ができなければ他ページの価値が生まれず、最重要のコア体験である。

**独立テスト方法**: 実行ページ単体で読み込み、オーケストレーション選択からプロンプト送信、結果表示までを確認すれば機能単体で価値を検証できる。

**受け入れシナリオ**:

1. **前提** `$MIXSEEK_WORKSPACE/configs/`配下に有効な`.toml`ファイルが存在し、実行ページが開いている **状況で** オペレーターがページを読み込むと、 **結果** すべての設定ファイルから読み取ったオーケストレーション選択肢（「ファイル名 - オーケストレーション名」形式）がドロップダウンで表示される。
2. **前提** 実行ページが開いており、オーケストレーションが選択され、プロンプト欄に有効なテキストが入力されている **状況で** オペレーターがタスク実行を開始すると、 **結果** 実行開始が通知され、Streamlit標準コンポーネント（st.spinner, st.status等）によるシンプルな進行状況表示（実行状態、現在ラウンド番号等）が表示され、完了後に詳細な結果（チーム進捗テーブル、タブ、グラフ等）が提示される。
3. **前提** 実行ページが開いているが、プロンプト欄が空欄である **状況で** オペレーターが実行を開始しようとすると、 **結果** 提出が阻止され適切なエラーメッセージが表示される。
4. **前提** 実行ページが開いているが、オーケストレーションが選択されていない **状況で** オペレーターが実行を開始しようとすると、 **結果** 提出が阻止され「オーケストレーションを選択してください」というエラーメッセージが表示される。
5. **前提** タスク実行中でmixseek.dbのround_progressテーブルにラウンドデータが記録されている **状況で** オペレーターが進行状況を確認すると、 **結果** Streamlit標準コンポーネント（st.status等）に現在ラウンド番号（例: "ラウンド 3/10"）がリアルタイムで表示される。
6. **前提** タスク実行が完了し、mixseek.dbのround_progressテーブルに複数チームのラウンドデータが存在する **状況で** オペレーターが実行ページの進捗確認領域を確認すると、 **結果** テーブル形式で各チームの名称、現在ラウンド番号、完了数が一覧表示され、チーム間の進捗の違いが把握できる。
7. **前提** タスク実行が完了し、サブミッションデータが存在する **状況で** オペレーターが実行ページのタブエリアを確認すると、 **結果** 「タスク」タブと各チーム名のタブ（例: "チームA", "チームB"）が表示され、「タスク」タブにはユーザーが入力したプロンプトが、各チームタブにはそのチームの最終サブミッション（`final_submission = TRUE`のレコード。全ラウンド完了時は最高スコアが最終サブミッション）の内容が表示される。

---

### ユーザーストーリー2 - リーダーボードで成績を把握する (Priority: P2)

プログラムレビュアーとして、結果ページのリーダーボードを確認し、最高スコアのサブミッションを閲覧したい。そうすることで、どのチームが最も優れているかを素早く理解できる。

**この優先度の理由**: リーダーボードの洞察は意思決定に不可欠であり、実行結果に文脈を与える。

**独立テスト方法**: 結果ページにサンプルの順位データを読み込み、ランキング表示とトップサブミッション詳細の表示が機能するかを確認する。

**受け入れシナリオ**:

1. **前提** 結果ページにリーダーボードデータが存在する **状況で** レビュアーがページを開くと、 **結果** スコア順に並んだチーム一覧とトップサブミッションのハイライトが即時に表示される。
2. **前提** リーダーボードが表示されている **状況で** レビュアーが任意のチームをクリックすると、 **結果** そのチームの詳細ビューが開き、提出内容やスコア、関連する指標が表示される。

---

### ユーザーストーリー3 - 設定ファイルを管理する (Priority: P3)

運用管理者として、`$MIXSEEK_WORKSPACE/configs/`配下の設定ファイル一覧を確認し、特定のファイルを選択して内容（Member Agent・Leader Agent・オーケストレーション定義）を編集、または新規設定ファイルを作成・削除したい。そうすることで、実行環境の設定を柔軟に管理できる。

**この優先度の理由**: 適切な設定管理が整っていなければ実行品質が担保できないため、運用面の基盤となる機能である。

**独立テスト方法**: 設定ページ単体でアクセスし、設定ファイルの一覧表示・選択・編集・作成・削除が行えるか確認すれば他ページに依存しない。

**受け入れシナリオ**:

1. **前提** `$MIXSEEK_WORKSPACE/configs/`配下に複数の`.toml`ファイルが存在する **状況で** 管理者が設定ページを開くと、 **結果** すべての`.toml`ファイル名が一覧表示される。
2. **前提** 設定ファイル一覧が表示されている **状況で** 管理者が特定のファイルを選択すると、 **結果** そのファイルの内容（Member Agent、Leader Agent、オーケストレーション定義）が編集可能な形式で表示される。
3. **前提** 設定ファイルの内容を編集した **状況で** 管理者が保存すると、 **結果** 同じファイルに変更が書き戻され、成功メッセージが表示される。
4. **前提** 設定ページが開いている **状況で** 管理者が新規作成を選択し、ファイル名を入力すると、 **結果** テンプレート構造を持つ新規`.toml`ファイルが`configs/`配下に作成され、編集可能な状態で表示される。
5. **前提** 設定ファイル一覧が表示されている **状況で** 管理者が特定のファイルの削除を選択すると、 **結果** 確認ダイアログが表示され、承認後にファイルが削除される。

---

### ユーザーストーリー4 - 過去の実行履歴を確認する (Priority: P2)

プログラムレビュアーとして、履歴ページから過去のタスク実行履歴を一覧で確認し、特定の実行の詳細を閲覧したい。そうすることで、過去の試行を振り返り、パターンやトレンドを把握できる。

**この優先度の理由**: 履歴の振り返りは改善サイクルに不可欠であり、結果ページが最新状態を示すのに対し、履歴ページは時系列での分析を可能にする。

**独立テスト方法**: 履歴ページ単体でアクセスし、mixseek.dbに保存された過去の実行データが一覧表示され、個別の詳細表示が機能するか確認する。

**受け入れシナリオ**:

1. **前提** mixseek.dbに複数の過去実行データが存在する **状況で** レビュアーが履歴ページを開くと、 **結果** 基本情報（実行ID、プロンプト概要、実行日時、ステータス、使用オーケストレーション）の一覧が時系列順（新しい順）に1ページあたり50件表示され、日時の昇順/降順切り替えとステータスによる絞り込みが可能であり、ページ送り機能により追加データにアクセスできる。
2. **前提** 履歴一覧が表示されている **状況で** レビュアーが特定の実行をクリックすると、 **結果** その実行の詳細ビューが開き、完全なプロンプト、結果サマリー、スコア、使用されたLeader Agent・Member Agent、実行時刻、エラー情報（存在する場合）が表示される。
3. **前提** mixseek.dbに履歴データが存在しない **状況で** レビュアーが履歴ページを開くと、 **結果** 「実行履歴がありません。タスクを実行すると履歴が記録されます」という案内メッセージと実行ページへのリンクが表示される。

---

### ユーザーストーリー5 - ラウンド進捗とスコア推移を確認する (Priority: P2)

プログラムレビュアーとして、結果ページでラウンドの進捗状況（現在ラウンド番号と完了数、各ラウンドの開始/終了時刻のタイムライン）を確認し、全チームのスコア推移を折れ線グラフで閲覧したい。そうすることで、競技の全体的な進行状況とチーム間のパフォーマンス推移を把握できる。

**この優先度の理由**: ラウンドコントローラの実装により利用可能になる重要な分析機能であり、競技の進行状況とチームパフォーマンスの可視化は意思決定に不可欠である。

**独立テスト方法**: 結果ページにmixseek.dbの専用テーブル（round_progress, round_scores）からサンプルデータを読み込み、ラウンド進捗表示とスコア推移グラフが機能するか確認する。

**受け入れシナリオ**:

1. **前提** mixseek.dbのround_progressテーブルにラウンドデータが存在する **状況で** レビュアーが結果ページを開くと、 **結果** リーダーボード下に現在ラウンド番号と完了数（例: "ラウンド 3/10"）が表示され、各ラウンドの開始/終了時刻がタイムライン形式で時系列表示される。
2. **前提** mixseek.dbのround_scoresテーブルに全チームのスコアデータが存在する **状況で** レビュアーが結果ページのスコア推移エリアを閲覧すると、 **結果** ラウンド番号をX軸、スコアをY軸とする折れ線グラフが表示され、全チームの推移が異なる色で同時に表示される。
3. **前提** mixseek.dbにラウンドデータが存在しない **状況で** レビュアーが結果ページを開くと、 **結果** ラウンド進捗エリアに「ラウンドデータがありません。ラウンドコントローラによる実行後に表示されます」という案内メッセージが表示される。

---

### エッジケース

- 環境変数`MIXSEEK_WORKSPACE`が未設定の状態でUI起動を試みた場合、明示的なエラーメッセージを表示してアプリケーション起動を中断する。
- `$MIXSEEK_WORKSPACE/configs/`ディレクトリが存在しない場合、UI起動時に自動作成し、空のディレクトリとして扱う。
- `$MIXSEEK_WORKSPACE/configs/`配下に`.toml`ファイルが1つも存在しない場合、実行ページのオーケストレーション選択肢は空となり、「設定ファイルが見つかりません。設定ページで作成してください」というメッセージと設定ページへのリンクを表示する。
- 既存のタスク実行が進行中の状態で新しいタスクを開始しようとした場合、実行ボタンを無効化し「タスク実行中です。完了するまでお待ちください」という警告メッセージを表示して新規実行をブロックする。
- タスク実行中にエラーが発生した場合（Orchestratorの例外、タイムアウト、データベース接続エラー等）、リアルタイム進捗表示のポーリングを即座に停止し、エラーメッセージ（エラーの種類と詳細）を明確に表示し、実行ボタンを再度有効化して次の実行を可能にする。
- 設定ファイル内のTOML構文にエラーがある場合、そのファイルはオーケストレーション選択肢に表示せず、設定ページでファイルを選択した際に「構文エラー: [エラー詳細]」というメッセージを表示する。
- 設定ファイルの新規作成時に既存のファイル名と重複する名前を入力した場合、「ファイル名が既に存在します」というエラーメッセージを表示し、作成を中断する。
- 設定ファイルの削除時に確認ダイアログで「キャンセル」を選択した場合、削除を中断し、ファイル一覧に戻る。
- リーダーボードに表示するサブミッションやスコアがまだ存在しない場合、「データがありません。タスクを実行すると結果が表示されます」という案内メッセージと実行ページへのリンクボタンを表示する。
- mixseek.dbのround_progressまたはround_scoresテーブルにラウンドデータが存在しない場合、ラウンド進捗エリアに「ラウンドデータがありません。ラウンドコントローラによる実行後に表示されます」という案内メッセージを表示する。
- `mixseek.db`ファイルが存在しない場合、リーダーボードは空状態として扱い、データ不在時の案内メッセージを表示する（エラーとはしない）。
- スコア推移グラフに表示するチーム数が多い（例: 50チーム以上）場合、グラフの可読性を維持するため、凡例を折りたたみ可能にし、個別チームの表示/非表示を切り替えられるようにする。
- 履歴ページでmixseek.dbに実行履歴が存在しない場合、「実行履歴がありません。タスクを実行すると履歴が記録されます」という案内メッセージと実行ページへのリンクを表示する。
- 履歴ページでフィルタ適用後に該当データが0件になった場合、「該当する実行履歴が見つかりません」というメッセージとフィルタ解除リンクを表示する。
- 実行ページの進捗確認領域でチーム進捗データが存在しない場合、「チーム進捗データがありません」という案内メッセージを表示する（エラーとはしない）。
- 実行ページの進捗確認領域で、一部のチームのみラウンドデータが存在する場合、データが存在するチームのみ表示し、データが存在しないチームは「データなし」または「-」と表示する。
- 実行ページのタブエリアでチーム数が多い（例: 10チーム以上）場合、タブバーがスクロール可能になり、すべてのチームタブにアクセスできるようにする。
- 実行ページのタブエリアで特定のチームのサブミッションデータが存在しない場合、そのチームタブに「サブミッションデータがありません」という案内メッセージを表示する。
- 実行ページのタブエリアでタスク実行前（プロンプト未入力）の場合、「タスク」タブのみ表示し、チームタブは表示しない。
- 実行ログセクションで`$MIXSEEK_WORKSPACE/logs/mixseek.log`が存在しない場合、「ログがありません」というメッセージを表示する（エラーとはしない）。ログファイルは最初のタスク実行時に自動作成される。
- 実行ログセクションでログファイルが非常に大きい（例: 10MB以上）場合でも、末尾100行のみを読み取るため、パフォーマンスに影響を与えない。

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、起動時に環境変数`MIXSEEK_WORKSPACE`からワークスペースパスを読み取り（未設定時はエラー終了）、`$MIXSEEK_WORKSPACE/configs/`ディレクトリが存在しない場合は自動作成し、主ナビゲーションからアクセスできる専用の実行ページを提供し、`mixseek exec` と同等の操作コンテキストを明示しなければならない。
- **FR-002**: システムは、実行ページでオーケストレーション選択ドロップダウンを提供し、`$MIXSEEK_WORKSPACE/configs/`配下のすべての`.toml`ファイルから読み取ったオーケストレーション定義を「ファイル名 - オーケストレーション名」形式で表示しなければならない。設定ファイルが存在しない場合は「設定ファイルが見つかりません。設定ページで作成してください」というメッセージと設定ページへのリンクを表示しなければならない。
- **FR-003**: システムは、複数行入力が可能で必須検証を行うタスクプロンプト欄を提供し、不正な入力時には理由付きメッセージを表示しなければならない。オーケストレーションが選択されていない場合は「オーケストレーションを選択してください」というエラーメッセージを表示しなければならない。
- **FR-004**: システムは、オペレーターがタスク実行を開始できる操作を備え、threadingを使用してバックグラウンドスレッドで実行を開始し、st.session_stateで実行状態を管理し、メインスレッドでst.rerun()を使用して2秒間隔で定期的に再レンダリングして`mixseek.db`から進捗を読み取りUI更新することで、Streamlit標準コンポーネント（st.spinner, st.status, st.progress等）を使用して進行状況（実行状態、現在ラウンド番号等）をシンプルに表示しなければならない。実行完了後は自動的にポーリング（st.rerun()の定期呼び出し）を停止し、詳細な結果（チーム進捗テーブル、タブ、グラフ等）を表示しなければならない。タスク実行中にエラーが発生した場合は、ポーリングを即座に停止し、エラーメッセージを明確に表示しなければならない。
- **FR-005**: システムは、直近の実行結果を実行ページ上に保持して再確認できるようにし、別ページに移動しなくても概要を参照できなければならない。
- **FR-006**: システムは、ワークスペース内の`mixseek.db`（DuckDB）から読み取ったデータを元に、結果ページにスコア順のリーダーボードを表示し、順位、スコア、最終更新時刻を示しつつ最高スコアのチームを視覚的に区別しなければならない。
- **FR-007**: システムは、`mixseek.db`から読み取った最高スコアサブミッションの専用ハイライト領域を提供し、スコア、サマリー、貢献エージェント、提出時刻をまとめて表示しなければならない。
- **FR-008**: システムは、リーダーボード上の任意のチームを選択した際に、`mixseek.db`から読み取ったサブミッション詳細、ラウンドごとのスコア推移（利用可能な場合）、注記を表示する詳細ビューを提供しなければならない。
- **FR-009**: システムは、結果ページのリーダーボード下に専用のラウンド進捗エリアを提供し、`mixseek.db`のround_progressテーブルから読み取った現在ラウンド番号と完了数（例: "ラウンド 3/10"）を表示し、各ラウンドの開始/終了時刻をタイムライン形式で時系列表示しなければならない。ラウンドデータが存在しない場合は「ラウンドデータがありません。ラウンドコントローラによる実行後に表示されます」という案内メッセージを表示しなければならない。
- **FR-010**: システムは、設定ページで`$MIXSEEK_WORKSPACE/configs/`配下のすべての`.toml`ファイルを一覧表示しなければならない。一覧には各ファイル名と最終更新日時を含み、ファイルを選択すると、その内容（Member Agent、Leader Agent、オーケストレーション定義）を編集可能な形式で表示しなければならない。
- **FR-011**: システムは、設定ページで新規設定ファイルを作成する機能を提供し、ファイル名入力後にテンプレート構造（空のMember Agent、Leader Agent、オーケストレーションセクション）を持つ新規`.toml`ファイルを`$MIXSEEK_WORKSPACE/configs/`配下に作成し、編集可能な状態で表示しなければならない。ファイル名が既存のファイルと重複する場合は「ファイル名が既に存在します」というエラーメッセージを表示し、作成を中断しなければならない。
- **FR-012**: システムは、設定ページで選択した設定ファイルの内容を編集後、保存ボタンをクリックすると、同じファイルパスに変更を書き戻し、成功メッセージを表示しなければならない。TOML構文エラーが存在する場合は、「構文エラー: [エラー詳細]」というメッセージを表示し、保存を中断しなければならない。
- **FR-013**: システムは、設定ページで設定ファイルの削除機能を提供し、削除を選択すると「このファイルを削除してもよろしいですか？」という確認ダイアログを表示しなければならない。承認後にファイルを削除し、一覧を更新しなければならない。キャンセルを選択した場合は削除を中断し、ファイル一覧に戻らなければならない。
- **FR-014**: システムは、タスク実行を直列化し、既に実行中のタスクが存在する場合は実行ボタンを無効化して「タスク実行中です。完了するまでお待ちください」という警告メッセージを表示し、現在の実行が完了するまで新規実行をブロックしなければならない。
- **FR-015**: システムは、リーダーボードにサブミッションやスコアが存在しない場合、「データがありません。タスクを実行すると結果が表示されます」という案内メッセージと実行ページへのリンクボタンを表示しなければならない。
- **FR-016**: システムは、主ナビゲーションからアクセスできる専用の履歴ページを提供し、`mixseek.db`から過去の実行履歴を読み取って一覧表示しなければならない。一覧には基本情報（実行ID、プロンプト概要、実行日時、ステータス、使用オーケストレーション）を含み、1ページあたり50件のページネーションで表示し、日時の昇順/降順ソート切り替えとステータスによる絞り込みフィルタを提供しなければならない。
- **FR-017**: システムは、履歴一覧で特定の実行を選択した際に詳細ビューを表示し、完全なプロンプト、結果サマリー、スコア、使用されたLeader Agent・Member Agent、実行時刻、エラー情報（存在する場合）を提示しなければならない。
- **FR-018**: システムは、履歴データが存在しない場合に「実行履歴がありません。タスクを実行すると履歴が記録されます」という案内メッセージと実行ページへのリンクを表示し、フィルタ適用後に該当データが0件の場合は「該当する実行履歴が見つかりません」というメッセージとフィルタ解除リンクを表示しなければならない。
- **FR-019**: システムは、履歴データの削除機能を提供せず、`mixseek.db`に記録された実行履歴は永続的に保持しなければならない。
- **FR-020**: システムは、結果ページのラウンド進捗エリア下に専用のスコア推移エリアを提供し、`mixseek.db`のround_scoresテーブルから読み取った全チームのスコアデータを元に、ラウンド番号をX軸、スコアをY軸とする折れ線グラフを表示しなければならない。全チームの推移を異なる色で同時に表示し、各チームを識別できる凡例を提供しなければならない。
- **FR-021**: システムは、スコア推移グラフに表示するチーム数が多い（例: 50チーム以上）場合、グラフの可読性を維持するため、凡例を折りたたみ可能にし、個別チームの表示/非表示を切り替えられるインタラクティブ機能を提供しなければならない。
- **FR-022**: システムは、タスク実行中にStreamlit標準コンポーネント（st.status等）を使用して現在ラウンド番号（例: "ラウンド 3/10"）をシンプルに表示し、FR-004のポーリング機構により`mixseek.db`のround_progressテーブルから読み取ってリアルタイム更新しなければならない。ラウンドデータが存在しない場合は何も表示しない（エラーとはしない）。
- **FR-023**: システムは、タスク実行完了後に実行ページの専用の進捗確認領域（テーブル）を提供し、`mixseek.db`のround_progressテーブルから読み取った各チームの名称、現在ラウンド番号、完了数を一覧表示しなければならない。チームは非同期で並列実行されるため、チーム間で異なるラウンド番号を表示できなければならない。ラウンドデータが存在しない場合は「チーム進捗データがありません」という案内メッセージを表示しなければならない。
- **FR-024**: システムは、タスク実行完了後に実行ページにタブインターフェースを提供し、「タスク」タブと各チーム名タブ（チーム数に応じて動的に生成）で構成しなければならない。「タスク」タブにはユーザーが入力したプロンプトを表示し、各チームタブには`mixseek.db`の`leader_board`テーブルから読み取ったそのチームの**最終サブミッション**（`final_submission = TRUE`のレコード。全ラウンド完了時は最高スコアが最終サブミッションである。実行途中終了時は最高スコアのラウンド）の内容（スコア、サブミッション内容、提出時刻）を表示しなければならない。タスク実行中はタブを表示しない。サブミッションデータが存在しない場合は「サブミッションデータがありません」という案内メッセージを表示しなければならない。
- **FR-025**: システムは、各チームタブのスコア詳細表示において、`score_details`のJSON構造を解析し、`overall_score`と各メトリクス（`metrics`配列）を構造化して表示しなければならない。各メトリクスの`evaluator_comment`はMarkdown形式でレンダリングしなければならない。JSON解析が失敗した場合、または`score_details`が期待される構造を持たない場合は、生のJSON文字列をコードブロックとして表示しなければならない（エラーとはしない）。
- **FR-026**: システムは、実行ページに折りたたみ可能な「実行ログ」セクションを提供し、`$MIXSEEK_WORKSPACE/logs/mixseek.log`からINFO以上のログメッセージを読み取ってリアルタイムで表示しなければならない。ログ表示はスクロール可能なテキストエリアとし、タスク実行中はFR-004のポーリング機構により2秒間隔で更新しなければならない。実行完了後もログを参照可能な状態を維持しなければならない。ログファイルが存在しない場合は「ログがありません」というメッセージを表示しなければならない（エラーとはしない）。

### キーエンティティ

- **設定ファイル**: `$MIXSEEK_WORKSPACE/configs/`配下に配置される`.toml`形式のファイル。Member Agent定義、Leader Agent定義、オーケストレーション定義を含む。ファイル名、最終更新日時、TOML構造を保持する。
- **タスク実行**: オペレーターが開始する単一の実行。プロンプト、選択されたオーケストレーション（ファイル名+オーケストレーション名）、ステータス、タイムスタンプ、結果要約を保持する。
- **チーム**: リーダーボード上で競う単位。名称、所属、累積スコア、順位、紐づくサブミッションを含む。
- **サブミッション**: チームが提出する評価結果。スコア、要約、貢献したエージェント、提出時刻、ラウンドとの関連を保持する。
- **エージェント**: Member／Leader双方を含む概念。識別子、役割、能力、ステータス、設定ファイル内での定義位置を含む。
- **オーケストレーション**: 1つのLeader Agentと複数のMember Agent、および設定メタデータを束ねる構成単位。設定ファイル内で定義される。
- **ラウンド**: 競技の進行単位。ラウンド番号、開始時刻、終了時刻、ステータス（進行中/完了）を保持する。mixseek.dbのround_progressテーブルに格納される。
- **ラウンドスコア**: 特定ラウンドにおける各チームのスコア。チーム識別子、ラウンド番号、スコア値、記録時刻を保持する。mixseek.dbのround_scoresテーブルに格納され、スコア推移グラフのデータソースとなる。

## 前提条件

- 初期実装のUIはStreamlitを使用し、将来的なフレームワーク変更は別途評価する。
- ワークスペースパスはUI起動時に環境変数`MIXSEEK_WORKSPACE`から読み取り、UI実行中は変更不可とする。環境変数が未設定の場合はエラーメッセージを表示してUI起動を中断する。
- `$MIXSEEK_WORKSPACE/configs/`ディレクトリが存在しない場合、UI起動時に自動作成する。
- 設定ファイルは`$MIXSEEK_WORKSPACE/configs/`配下に`.toml`形式で配置され、各ファイルはMember Agent、Leader Agent、オーケストレーション定義を含むことができる。ファイル名は固定ではなく、ユーザーが任意に命名できる。
- 実行ページでは、ユーザーが`configs/`配下のすべての`.toml`ファイルから読み取ったオーケストレーション選択肢（「ファイル名 - オーケストレーション名」形式）から実行時のオーケストレーションを選択する。
- 対象ページへのアクセスは、認証済みの内部ユーザーで、オペレーター／レビュアー／管理者のロール権限を持つ利用者に限定される。
- ラウンド進捗とスコア推移の機能はラウンドコントローラの実装完了後に利用可能となり、`mixseek.db`のround_progressおよびround_scoresテーブルにデータが存在する場合に表示される。データが存在しない場合は案内メッセージを表示する。
- チームは非同期で並列に実行されるため、各チームのラウンド進捗は独立して進行し、同じ時点で異なるラウンド番号を持つことがある。UIはこの非同期性を考慮し、各チームの現在ラウンドを個別に表示する。
- リーダーボードやサブミッション要約に用いるスコア情報は、ワークスペース内のDuckDBファイル（`mixseek.db`）から直接読み取る。ファイルが存在しない場合は空状態として扱い、エラーとはしない。
- Logfire観測機能はオプションであり、CLIオプション（`--logfire`, `--logfire-metadata`, `--logfire-http`）で有効化可能。環境変数でも制御可能。

### Logfire統合（オプション機能）

Mixseek UIは、Logfireによるリアルタイム観測機能を提供します。

**CLIオプション**:
- `--logfire`: Full mode（すべてキャプチャ、開発環境推奨）
- `--logfire-metadata`: Metadata only mode（プロンプト/応答除外、本番推奨）
- `--logfire-http`: Full + HTTP capture mode（デバッグ用）

**動作**:
- UI起動時に環境変数`LOGFIRE_ENABLED=1`を設定
- app.py で環境変数を検出して`setup_logfire()`を実行
- サイドバーにLogfire状態表示（有効/無効/エラー）
- UI上で実行したオーケストレーションのトレースをLogfireで観測可能

詳細は[docs/ui-guide.md](../../docs/ui-guide.md)および[docs/observability.md](../../docs/observability.md)を参照。

## 成功指標 *(必須)*

### 計測可能なアウトカム

- **SC-001**: パイロットテストで、オペレーターの90%以上がオーケストレーション選択から実行ページ訪問、タスク実行完了まで3分以内に自力で完了できる。
- **SC-002**: ユーザビリティ評価で、レビュアーの80%以上が15秒以内にトップサブミッションを特定し詳細ビューを表示でき、満足度4/5以上を報告する。
- **SC-003**: 管理者は設定ファイルの作成・選択・編集・保存・削除の一連の操作を1ファイルあたり3分以内に完了でき、致命的エラーは記録されない。
- **SC-004**: リーダーボードに最大100チームのデータを読み込んだ状態で、結果ページは2秒以内にランキングとトップサブミッションを表示できる。
- **SC-005**: 履歴ページに500件の実行履歴データが存在する状態で、初回ページ表示（50件）は2秒以内に完了し、ページ送り操作は1秒以内に応答できる。
- **SC-006**: ユーザビリティ評価で、レビュアーの85%以上が履歴ページで特定の過去実行を30秒以内に特定し、詳細を閲覧できる。
- **SC-007**: `configs/`配下に10個の`.toml`ファイルが存在する状態で、実行ページのオーケストレーション選択肢の読み込みが1秒以内に完了する。
- **SC-008**: round_progressテーブルに10ラウンド分のデータが存在する状態で、結果ページのラウンド進捗エリア（現在ラウンド表示とタイムライン）は1.5秒以内に表示できる。
- **SC-009**: round_scoresテーブルに50チーム×10ラウンド分のスコアデータが存在する状態で、スコア推移グラフは3秒以内に描画でき、凡例の折りたたみ/展開操作は0.5秒以内に応答できる。
- **SC-010**: ユーザビリティ評価で、レビュアーの80%以上がラウンド進捗エリアとスコア推移グラフを確認して、特定チームのパフォーマンス傾向（上昇/下降/停滞）を20秒以内に把握できる。
- **SC-011**: タスク実行中でround_progressテーブルに10ラウンド分のデータが記録されている状態で、Streamlit標準コンポーネント（st.status等）による現在ラウンド表示（例: "ラウンド 3/10"）のポーリング更新は2秒間隔で実行でき、UIの応答性を損なわない。
- **SC-012**: タスク実行完了後、round_progressテーブルに50チーム×各10ラウンド分のデータが存在する状態で、実行ページの進捗確認領域（テーブル形式の全チームラウンド状況一覧）は2秒以内に表示でき、非同期で異なるラウンド番号を持つチームの進捗を正確に表示できる。
- **SC-013**: タスク実行完了後、実行ページのタブエリアで10チーム分のサブミッションデータが存在する状態で、タブの初期表示は1秒以内に完了し、タブ切り替え操作は0.3秒以内に応答できる。ユーザビリティ評価で、オペレーターの90%以上が特定チームのサブミッション内容を10秒以内に確認できる。
- **SC-014**: タスク実行中、実行ログセクションはFR-004のポーリング機構（2秒間隔）により更新され、ログファイルの末尾100行の読み取りと表示は0.5秒以内に完了できる。ユーザビリティ評価で、オペレーターの85%以上がエラー発生時にログセクションから原因を15秒以内に特定できる。

## Clarifications

### Session 2025-11-06

- Q: ワークスペースパスはどのように決定するか？ → A: ワークスペースパスをUI起動時に環境変数MIXSEEK_WORKSPACEから読み取り、変更不可とする(完全固定)
- Q: 既存のタスク実行が進行中の状態で新しいタスクを開始した場合の挙動は？ → A: 実行を直列化し、進行中のタスクがある場合は警告を表示して新規実行をブロックする
- Q: リーダーボードにサブミッションやスコアが存在しない場合の表示方法は？ → A: 「データがありません。タスクを実行すると結果が表示されます」という案内メッセージとCTA（実行ページへのリンク）を表示
- Q: リーダーボードとサブミッションのデータソースは？ → A: ワークスペース内のDuckDBファイル（mixseek.db）から直接読み取り、存在しない場合は空状態として扱う
- Q: 履歴確認ページの配置方法は？ → A: 独立した「履歴ページ」を追加し、ナビゲーションから直接アクセス可能にする
- Q: 履歴一覧に表示する情報の範囲は？ → A: 基本情報（実行ID、プロンプト概要、実行日時、ステータス、使用オーケストレーション）を一覧表示し、詳細ビューで完全な情報を表示
- Q: 履歴一覧で提供するフィルタ・ソート・検索機能は？ → A: 基本的なソート（日時の昇順/降順切り替え）と簡易フィルタ（ステータスによる絞り込み）のみ提供
- Q: 履歴データの削除機能は？ → A: 削除機能は提供せず、mixseek.dbのデータは永続的に保持する
- Q: 大量の履歴データ表示時の処理方法は？ → A: ページネーション（1ページあたり50件）を実装し、ページ送り機能を提供
- Q: `$MIXSEEK_WORKSPACE/configs/`ディレクトリ内で設定ファイルとして認識する基準は？ → A: `.toml`拡張子を持つファイルのみを設定ファイルとして認識する
- Q: 設定ページでの設定ファイル編集方法は？ → A: 設定ファイルを選択すると内容を編集可能な形式で表示し、保存時に同じファイルに書き戻す
- Q: 実行ページでのオーケストレーション選択肢の表示方法は？ → A: `configs/`配下のすべての`.toml`ファイルからオーケストレーション定義を読み取り、ファイル名とオーケストレーション名を組み合わせて選択肢として表示
- Q: 新規設定ファイル作成機能は？ → A: 新規設定ファイル作成機能を提供し、ファイル名入力とテンプレート（空の設定構造）を使って`configs/`配下に新規`.toml`ファイルを作成できる
- Q: 設定ファイルの削除機能は？ → A: 設定ファイルの削除機能を提供し、削除前に確認ダイアログを表示する

### Session 2025-11-13

- Q: ラウンド進捗・スコア推移の表示エリアはどのページに配置しますか？ → A: 結果ページ内に配置（リーダーボード下または専用タブ）
- Q: 「ラウンドの進捗」として表示する情報は何ですか？ → A: タイムライン形式（各ラウンドの開始/終了時刻を時系列表示）+ 現在ラウンド番号と完了数（例: "ラウンド 3/10"）
- Q: 「スコアの推移」の可視化形式は何を使用しますか？ → A: 折れ線グラフ（ラウンド番号をX軸、スコアをY軸）
- Q: スコア推移グラフはどのチームを対象に表示しますか？ → A: 全チームを同時表示（複数の折れ線を色分けして1つのグラフに表示）
- Q: ラウンド進捗とスコア推移のデータソースはどこから取得しますか？ → A: mixseek.db内の専用テーブル（例: round_progress, round_scores）
- Q: ラウンド進捗の表示は実行ページでも必要ですか？ → A: 実行中は現在ラウンド番号と完了数（例: "ラウンド 3/10"）をStreamlit標準コンポーネントで表示。実行完了後はチーム進捗テーブル、タブ、グラフを表示（結果ページでもタイムライン・スコア推移グラフを表示）
- Q: 個別チームのラウンド状況はどこに表示しますか？ → A: 実行完了後に実行ページの進捗確認領域（テーブル）に各チームの現在ラウンド番号と完了数を一覧表示する（実行中は表示しない）
- Q: 実行ページでタスクとサブミッションを表示する際のタブ構成は？ → A: 実行完了後にタスクタブ（プロンプト表示）+ 各チームごとに個別タブ（例: タスク / チームA / チームB / チームC）を表示（実行中は表示しない）
- Q: リアルタイム進捗の更新方法として、どの実装パターンを使用しますか？ → A: データベースポーリング（バックグラウンドスレッド実行） - 実行を別スレッドで開始し、メインスレッドでDBを定期的にポーリングしてUI更新
- Q: 実行中のリアルタイム進捗表示として、具体的にどの情報を表示しますか？ → A: Streamlit標準コンポーネント（st.spinner, st.status, st.progress等）でシンプルな進捗表示（実行状態、現在ラウンド番号等）。タブ、テーブル、グラフなどの詳細な静的情報は実行完了後にのみ表示する
- Q: データベースポーリングの間隔はどのように設定しますか？ → A: 2秒間隔（固定） - UIの応答性とデータベース負荷のバランスが優れた設定
- Q: タスク実行中にエラーが発生した場合、リアルタイム進捗表示はどのように動作しますか？ → A: ポーリングを停止し、エラーメッセージを即座に表示する
- Q: バックグラウンドスレッドでの実行とポーリング更新を実現するために、どのStreamlit機能を使用しますか？ → A: st.session_state + st.rerun() + threading（Streamlit標準パターン）

### Session 2025-11-18

- Q: FR-024の「最終ラウンドのサブミッション」の定義として、どのレコードを表示すべきか？ → A: `leader_board`テーブルの`final_submission = TRUE`のレコードを優先。全ラウンド完了時は最高スコアが最終サブミッションである。実行途中終了時（failed/partial_failure）は最高スコアのラウンドを表示する
- Q: スコア詳細表示で`evaluator_comment`のMarkdownレンダリングが失敗した場合、またはJSON構造が期待と異なる場合の動作は？ → A: JSON解析失敗時または構造不一致時は、生のJSON文字列をコードブロック（`st.code()`）として表示する。フォールバック処理ではなく、明示的な仕様要件として定義
