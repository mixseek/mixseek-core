# 機能仕様書: MixSeek設定管理システム

**機能ブランチ**: `002-mixseek-core-config`
**作成日**: 2025-10-15
**ステータス**: ドラフト
**入力**: ユーザー説明: "次の設定に関する要件・仕様を検討してください、不明な点はユーザにヒアリングしてください..."

## Clarifications

### Session 2025-10-15

- Q: TOML設定の動的性について：「後続のラウンドで新しい設定」という表現は誤解を招く可能性がある → A: TOML設定内容は静的で、システム実行開始から終了まで同じ設定が維持される。ラウンド中に動的に変更されることはない
- Q: 設定ファイル構造：個別のTOMLファイルをどのように整理し命名するべきか？ → A: 個別ファイル: system.toml, teams.toml, leader-agents.toml, member-agents.toml, rounds.toml
- Q: 認証環境変数の詳細仕様について → A: 認証情報は本仕様のスコープ外とする
- Q: 「競技ラウンド」という表現について → A: 「競技ラウンド」は誤解を招く。ラウンドはエージェントがユーザの求める回答を得るための反復処理である

### Session 2025-10-21

- Q: Pydantic AIを採用するに当たってMCPは将来機能になったため、仕様からMCPに関する記述を削除する必要がある → A: MCP関連の記述を削除し、ツール設定として表現を統一する
- Q: 「終了ロジック」の設定は設定項目から除外する必要がある → A: ラウンドコントローラー設定から終了ロジックに関する記述を削除し、最大ラウンド数のみを設定項目として残す

## ユーザーシナリオ & テスト *(必須)*

### ユーザーストーリー 1 - 新規MixSeekワークスペースの初期化 (優先度: P1)

開発チームが新しいMixSeekワークスペースをデフォルト設定と例で設定し、システム構造を理解してカスタマイズを開始する。

**この優先度の理由**: これは他のすべての設定管理活動の基盤となる。ワークスペースの初期化なしには、他の設定操作は実行できない。

**独立テスト**: 空のワークスペースで `mixseek init` を実行し、適切な構造とコメント例付きのデフォルト設定ファイルがすべて作成されることを検証することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** MIXSEEK_WORKSPACE環境変数が設定されたディレクトリで、**実行時** ユーザーが `mixseek init` を実行すると、**結果** デフォルトTOMLファイルを含む完全なconfigsディレクトリ構造が作成される
2. **前提条件** 既存のワークスペースで、**実行時** ユーザーが `mixseek init` を実行すると、**結果** システムは既存の設定を上書きせずに警告を表示する
3. **前提条件** 環境変数MIXSEEK_WORKSPACEが設定されていない場合、**実行時** ユーザーが `mixseek init` を実行すると、**結果** システムはセットアップ手順を含む明確なエラーメッセージを提供する

---

### ユーザーストーリー 2 - システムとチーム設定の構成 (優先度: P2)

システム管理者がデータベース設定、ログ記録、チーム定義を含むコアMixSeek環境を設定し、運用基盤を確立する。

**この優先度の理由**: エージェントが適切に設定されチームが機能するには、システム設定が必要。これによりコアプラットフォーム操作が可能になる。

**独立テスト**: system.tomlとチーム設定を変更し、システムが実行時にこれらの設定を正しく読み込み適用することを検証することでテスト可能。

**受け入れシナリオ**:

1. **前提条件** 初期化されたワークスペースで、**実行時** ユーザーがsystem.tomlをデータベースとログ設定で変更すると、**結果** システムは次回起動時にこれらの設定を使用する
2. **前提条件** チーム設定で、**実行時** ユーザーがチームファイルでリーダーエージェントとメンバーエージェントを定義すると、**結果** エージェントが登録されラウンド操作で利用可能になる
3. **前提条件** 設定ファイルに無効なTOML構文がある場合、**実行時** システムが設定を読み込むと、**結果** ファイルと行番号を示す明確なエラーメッセージが表示される

---

### ユーザーストーリー 3 - エージェントの動作と接続の設定 (優先度: P3)

チームメンバーがシステムプロンプト、LLMモデル、ツール設定を含む個別のエージェント設定をカスタマイズし、特定ドメインでのエージェントパフォーマンスを最適化する。

**この優先度の理由**: 最適化にとって重要だが、基本システムがデフォルト設定で動作した後にエージェント固有の調整を行うことができる。

**独立テスト**: エージェント設定ファイルを変更し、エージェントが実行中に指定されたプロンプト、モデルを使用することを検証することでテスト可能。

**受け入れシナリオ**:

1. **前提条件** エージェント設定ファイルで、**実行時** ユーザーがシステムプロンプトとLLMモデルを更新すると、**結果** 次回システム起動時にエージェントは新しい設定を使用する
2. **前提条件** エージェント設定で、**実行時** ユーザーがメンバーエージェントのツール設定を構成すると、**結果** エージェントは指定されたツールにアクセスできる
3. **前提条件** ラウンドコントローラーパラメータで、**実行時** ユーザーが最大ラウンド数を設定すると、**結果** システムは実行中にこれらの制限を尊重する

---

### エッジケース

- MIXSEEK_WORKSPACE環境変数が読み取り専用ディレクトリを指している場合はどうなるか？
- システムは実行時に破損または部分的に書き込まれたTOMLファイルをどう処理するか？
- 認証に必要な環境変数が存在しないか無効な場合はどうなるか？
- 設定ファイルが存在するがコメントのみまたは空の場合、システムはどう動作するか？
- チーム/エージェント設定に循環依存がある場合はどうなるか？

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはMIXSEEK_WORKSPACE環境変数からワークスペースの場所を読み取り、configsサブディレクトリを作成しなければならない
- **FR-002**: システムはコメント例付きのすべてのデフォルト設定ファイルを作成する `mixseek init` コマンドを提供しなければならない
- **FR-003**: システムはユーザー編集可能性のためにすべての設定データをTOML形式で保存しなければならない
- **FR-004**: システムは設定を5つの個別ファイルに分離しなければならない: system.toml（システム設定）、teams.toml（チーム定義）、leader-agents.toml（リーダーエージェント）、member-agents.toml（メンバーエージェント）、rounds.toml（ラウンドコントローラー）
- **FR-005**: システムは機密情報を環境変数からのみ読み取り、TOMLファイルには記述しないこと（認証の詳細は本仕様のスコープ外）
- **FR-006**: システムはTOML構文を検証し、無効な設定に対してファイル位置を含む明確なエラーメッセージを提供しなければならない
- **FR-007**: システムはチームごとに複数のリーダーエージェントとメンバーエージェントを持つチーム登録をサポートしなければならない
- **FR-008**: システムはリーダーボード機能のためのデータベース設定の構成を可能にしなければならない
- **FR-009**: システムは設定可能なログファイルの場所とパラメータを提供しなければならない
- **FR-010**: システムはシステム運用境界のためのリソース制限パラメータをサポートしなければならない
- **FR-011**: システムはリーダーエージェントとメンバーエージェントの両方でシステムプロンプトとLLMモデルの設定を可能にしなければならない
- **FR-012**: システムはメンバーエージェントのツール設定をサポートしなければならない
- **FR-013**: システムは最大ラウンド数を含むラウンドコントローラーパラメータ設定を可能にしなければならない
- **FR-014**: システムは設定スキーマが更新された際にユーザーカスタマイズを保持しなければならない
- **FR-015**: 将来のシステムは設定の表示と変更の両方のための `mixseek config` コマンドを提供しなければならない（サブコマンドで機能分離：例 `mixseek config show`, `mixseek config edit`）

### 主要エンティティ *(データが関与する場合は含める)*

- **設定ワークスペース**: すべてのMixSeek設定ファイルを含むルートディレクトリ、MIXSEEK_WORKSPACE/configsに配置
- **システム設定**: データベース接続、ログ記録、リソース制限を含むコアプラットフォーム設定
- **チーム定義**: リーダーエージェントとメンバーエージェントとその関係と役割のコレクション
- **エージェント設定**: プロンプト、モデル、機能を含む個別のエージェント設定
- **ラウンドコントローラー設定**: ラウンドの反復処理と制限を管理するパラメータ

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーは単一のコマンド実行で30秒以内に完全なワークスペース設定を初期化できる
- **SC-002**: 設定ファイルは人間が読み取り可能で、専門ツールなしでチームメンバーが編集可能である
- **SC-003**: 複雑なマルチチーム設定でもシステム起動時間は5秒以内を維持する
- **SC-004**: 設定エラーの95%が実行前に実行可能なエラーメッセージとともに検出・報告される
- **SC-005**: チームは設定ディレクトリをコピーし環境変数を設定することで、カスタマイズされた設定を新しい環境にデプロイできる
- **SC-006**: スキーマ更新時にシステムは既存の設定ファイルとの下位互換性を維持する

## 前提条件

- TOML形式は設定を管理するすべてのチームメンバーにとって受け入れ可能である
- 環境変数は認証資格情報を処理するための好ましく安全な方法である
- 設定変更にはシステム再起動が必要（初期段階ではホットリロードは不要）
- チームはファイルベースの設定管理に慣れている
- 親仕様「specs/001-specs」は全体的なシステムアーキテクチャと制約を定義している
- デフォルト設定はほとんどのユースケースで合理的な開始点を提供する
- 設定の複雑さはコンポーネントごとの単一TOMLファイル内で管理可能な範囲にとどまる