# =============================================================================
# MixSeek-Core Development Environment Makefile
# =============================================================================
# This Makefile provides development-specific commands and workflows for the
# MixSeek-Core project. It extends the common Makefile with development tools,
# debugging support, and AI development tool integration.

# Include common definitions and targets
include ../Makefile.common

# =============================================================================
# DEVELOPMENT ENVIRONMENT CONFIGURATION
# =============================================================================

# Environment identification
IMAGE_NAME := $(APP_NAME)/dev:latest
CONTAINER_NAME := $(APP_NAME)-dev
REPO := $(IMAGE_NAME)
ENV := dev

# Build arguments (inherit MIXSEEK_* variables from Makefile.common)
BUILD_ARGS := \
    --build-arg MIXSEEK_USERNAME=$(MIXSEEK_USERNAME) \
    --build-arg MIXSEEK_UID=$(MIXSEEK_UID) \
    --build-arg MIXSEEK_GID=$(MIXSEEK_GID) \
    --build-arg BUILD_DATE=$(shell date -u +"%Y-%m-%dT%H:%M:%SZ")

# Base Docker runtime options
BASE_DOCKER_OPTS := \
    --name $(CONTAINER_NAME) \
    --hostname $(CONTAINER_NAME) \
    -e TERM=xterm-256color

# Development-specific options
DEV_DOCKER_OPTS := \
    -v $(ROOTDIR):/app \
    -v $(ROOTDIR)/.cache:/home/$(MIXSEEK_USERNAME)/.cache \
    -v $(ROOTDIR)/.config:/home/$(MIXSEEK_USERNAME)/.config \
    --env-file=$(ROOTDIR)/.env.dev

# Combined runtime options
DOCKER_OPTS := $(BASE_DOCKER_OPTS) $(DEV_DOCKER_OPTS)

# Test-specific options
DOCKER_TEST_OPTS := \
    -v $(ROOTDIR)/tests:/app/tests \
    --env-file=$(ROOTDIR)/.env.test

# Debug-specific options
DEBUG_OPTS := \
    -p 5678:5678 \
    -e DEBUGPY_ENABLED=true

# Streamlit-specific options
STREAMLIT_OPTS := \
    -p 8501:8501

# =============================================================================
# CORE CONTAINER LIFECYCLE
# =============================================================================

.PHONY: run
run:
	@echo "üöÄ Starting development container: $(CONTAINER_NAME)"
	$(call check_env_file,$(ENV))
	@# „Éõ„Çπ„ÉàÂÅ¥„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí‰∫ãÂâç‰ΩúÊàêÔºàDocker„ÅårootÊâÄÊúâ„Åß‰ΩúÊàê„Åô„Çã„ÅÆ„ÇíÈò≤„ÅêÔºâ
	@mkdir -p $(ROOTDIR)/.cache $(ROOTDIR)/.config
	@# „ÇÇ„ÅórootÊâÄÊúâ„ÅÆÂ†¥Âêà„ÅØ‰øÆÊ≠£
	@if [ "$$(stat -c '%U' $(ROOTDIR)/.cache 2>/dev/null)" = "root" ]; then \
		echo "‚ö†Ô∏è  Fixing .cache directory ownership..."; \
		sudo chown -R $(MIXSEEK_USERNAME):$(MIXSEEK_USERNAME) $(ROOTDIR)/.cache; \
	fi
	@if [ "$$(stat -c '%U' $(ROOTDIR)/.config 2>/dev/null)" = "root" ]; then \
		echo "‚ö†Ô∏è  Fixing .config directory ownership..."; \
		sudo chown -R $(MIXSEEK_USERNAME):$(MIXSEEK_USERNAME) $(ROOTDIR)/.config; \
	fi
	@docker run $(DOCKER_OPTS) $(STREAMLIT_OPTS) -d $(IMAGE_NAME)
	@echo "‚úÖ Development container started"
	@echo "üí° Connect with: make bash"
	@echo "üí° Start Streamlit UI: make streamlit"
	@echo "üîó Container name: $(CONTAINER_NAME)"
	@echo "üîó Exposed ports: 5678 (debug), 8501 (streamlit)"

.PHONY: stop
stop:
	@echo "‚èπÔ∏è  Stopping development container: $(CONTAINER_NAME)"
	@docker stop $(CONTAINER_NAME) 2>/dev/null || echo "‚ÑπÔ∏è  Container $(CONTAINER_NAME) not running"

.PHONY: restart
restart: stop rm run
	@echo "‚úÖ Development container restarted"

# =============================================================================
# DEVELOPMENT WORKFLOW COMMANDS
# =============================================================================

.PHONY: lint
lint:
	@echo "üîç Running code linting with ruff"
	@docker run --rm $(DOCKER_OPTS) $(IMAGE_NAME) bash -c "cd /app && ruff check ."

.PHONY: format
format:
	@echo "‚ú® Formatting code with ruff"
	@docker run --rm $(DOCKER_OPTS) $(IMAGE_NAME) bash -c "cd /app && ruff format ."

.PHONY: check
check: lint
	@echo "üîç Running type checking with mypy"
	@docker run --rm $(DOCKER_OPTS) $(IMAGE_NAME) bash -c "cd /app && mypy . --ignore-missing-imports || echo '‚ö†Ô∏è  mypy not configured or errors found'"

.PHONY: fix
fix:
	@echo "üîß Auto-fixing linting issues"
	@docker run --rm $(DOCKER_OPTS) $(IMAGE_NAME) bash -c "cd /app && ruff check --fix ."

# =============================================================================
# TESTING COMMANDS
# =============================================================================

.PHONY: unittest
unittest:
	@echo "üß™ Running unit tests with pytest"
	$(call check_env_file,$(ENV))
	@docker run --rm $(DOCKER_OPTS) $(DOCKER_TEST_OPTS) $(IMAGE_NAME) \
		bash -c "cd /app && pytest --log-cli-level=INFO tests/"

.PHONY: only-test
only-test:
	@echo "üß™ Running specific test: $(ARG)"
	@if [ -z "$(ARG)" ]; then \
		echo "‚ùå Usage: make only-test ARG=tests/test_example.py"; \
		exit 1; \
	fi
	$(call check_env_file,$(ENV))
	@docker run --rm $(DOCKER_OPTS) $(DOCKER_TEST_OPTS) $(IMAGE_NAME) \
		bash -c "cd /app && pytest -s -vv --log-cli-level=INFO $(ARG)"

.PHONY: test-watch
test-watch:
	@echo "üîÑ Running tests in watch mode"
	$(call check_env_file,$(ENV))
	@docker run --rm $(DOCKER_OPTS) $(DOCKER_TEST_OPTS) $(IMAGE_NAME) \
		bash -c "cd /app && pytest-watch -- --log-cli-level=INFO tests/"

# =============================================================================
# DEBUGGING SUPPORT
# =============================================================================

.PHONY: debug
debug:
	@echo "üêõ Starting debug session"
	@if [ -z "$(ARG)" ]; then \
		echo "‚ùå Usage: make debug ARG=path/to/script.py"; \
		exit 1; \
	fi
	$(call check_env_file,$(ENV))
	@echo "üîó Debug server will listen on localhost:5678"
	@echo "üí° Configure your IDE to connect to localhost:5678"
	@docker run --rm $(DOCKER_OPTS) $(DEBUG_OPTS) $(IMAGE_NAME) \
		python -m debugpy --listen 0.0.0.0:5678 --wait-for-client $(ARG)

.PHONY: debug-server
debug-server:
	@echo "üêõ Starting debug server (no script execution)"
	$(call check_env_file,$(ENV))
	@echo "üîó Debug server listening on localhost:5678"
	@docker run --rm $(DOCKER_OPTS) $(DEBUG_OPTS) $(IMAGE_NAME) \
		python -m debugpy --listen 0.0.0.0:5678 --wait-for-client

# =============================================================================
# AI DEVELOPMENT TOOLS INTEGRATION
# =============================================================================

.PHONY: claude-code
claude-code:
	@echo "ü§ñ Running Claude Code"
	@if [ -z "$(ARG)" ]; then \
		echo "üí° Usage: make claude-code ARG='--help'"; \
		echo "üí° Example: make claude-code ARG='analyze src/main.py'"; \
	fi
	@docker exec -it $(CONTAINER_NAME) claude-code $(ARG)

.PHONY: codex
codex:
	@echo "ü§ñ Running OpenAI Codex"
	@if [ -z "$(ARG)" ]; then \
		echo "üí° Usage: make codex ARG='--help'"; \
		echo "üí° Example: make codex ARG='generate function to parse JSON'"; \
	fi
	@docker exec -it $(CONTAINER_NAME) codex $(ARG)

.PHONY: gemini
gemini:
	@echo "ü§ñ Running Gemini CLI"
	@if [ -z "$(ARG)" ]; then \
		echo "üí° Usage: make gemini ARG='--help'"; \
		echo "üí° Example: make gemini ARG='code-review src/main.py'"; \
	fi
	@docker exec -it $(CONTAINER_NAME) gemini-cli $(ARG)

# =============================================================================
# CONTAINER MANAGEMENT
# =============================================================================

.PHONY: exec
exec:
	@echo "‚ö° Executing command in container: $(ARG)"
	@if [ -z "$(ARG)" ]; then \
		echo "‚ùå Usage: make exec ARG='command to execute'"; \
		exit 1; \
	fi
	@docker exec -it $(CONTAINER_NAME) bash -c "cd /app && $(ARG)"

.PHONY: root
root:
	@echo "üîê Connecting as root user (for system administration)"
	@docker exec -it --user root $(CONTAINER_NAME) bash

.PHONY: ps
ps:
	@echo "üìã Container processes"
	@docker exec $(CONTAINER_NAME) ps aux

.PHONY: top
top:
	@echo "üìà Container resource usage"
	@docker exec -it $(CONTAINER_NAME) top

# =============================================================================
# DEVELOPMENT UTILITIES
# =============================================================================

.PHONY: install
install:
	@echo "üì¶ Installing additional Python package: $(ARG)"
	@if [ -z "$(ARG)" ]; then \
		echo "‚ùå Usage: make install ARG='package-name'"; \
		exit 1; \
	fi
	@docker exec -it $(CONTAINER_NAME) bash -c "cd /app && uv add $(ARG)"

.PHONY: pip-list
pip-list:
	@echo "üìã Installed Python packages"
	@docker exec $(CONTAINER_NAME) bash -c "cd /app && uv pip list"

.PHONY: node-list
node-list:
	@echo "üìã Installed Node.js packages"
	@docker exec $(CONTAINER_NAME) npm list -g --depth=0

.PHONY: env-info
env-info:
	@echo "‚ÑπÔ∏è  Development environment information"
	@docker exec $(CONTAINER_NAME) bash -c " \
		echo 'üêç Python: $(python --version)' && \
		echo 'üì¶ uv: $(uv --version)' && \
		echo 'üü¢ Node.js: $(node --version)' && \
		echo 'üì¶ npm: $(npm --version)' && \
		echo 'ü§ñ Claude Code: $(claude-code --version 2>/dev/null || echo not available)' && \
		echo 'ü§ñ Codex: $(codex --version 2>/dev/null || echo not available)' && \
		echo 'ü§ñ Gemini CLI: $(gemini-cli --version 2>/dev/null || echo not available)' \
	"

# =============================================================================
# HOT RELOAD AND FILE WATCHING
# =============================================================================

.PHONY: watch
watch:
	@echo "üëÄ Starting file watcher for hot reload"
	@docker exec -it $(CONTAINER_NAME) bash -c " \
		if command -v watchmedo >/dev/null 2>&1; then \
			watchmedo auto-restart --directory=/app --pattern='*.py' --recursive -- python /app/main.py; \
		else \
			echo '‚ö†Ô∏è  watchdog not installed. Install with: make install ARG=watchdog'; \
		fi"

# =============================================================================
# DEVELOPMENT SERVER SHORTCUTS
# =============================================================================

.PHONY: server
server:
	@echo "üåê Starting development server"
	@docker exec -it $(CONTAINER_NAME) bash -c "cd /app && python -m http.server 8000"

.PHONY: streamlit
streamlit:
	@echo "üé® Starting Streamlit UI (Feature 076-ui)"
	@if [ -z "$$MIXSEEK_WORKSPACE" ]; then \
		echo "‚ùå MIXSEEK_WORKSPACE environment variable not set"; \
		echo "üí° Example: export MIXSEEK_WORKSPACE=/path/to/workspace"; \
		exit 1; \
	fi
	@echo "üîó Streamlit will be available at http://localhost:8501"
	@echo "üí° Make sure container was started with: docker run -p 8501:8501 ..."
	@docker exec -it $(CONTAINER_NAME) bash -c "cd /app && uv run mixseek ui --server.address 0.0.0.0"

.PHONY: jupyter
jupyter:
	@echo "üìì Starting Jupyter notebook server"
	@docker exec -it $(CONTAINER_NAME) bash -c " \
		if command -v jupyter >/dev/null 2>&1; then \
			jupyter notebook --ip=0.0.0.0 --port=8888 --allow-root --no-browser; \
		else \
			echo '‚ö†Ô∏è  Jupyter not installed. Install with: make install ARG=jupyter'; \
		fi"

# =============================================================================
# HELP AND STATUS
# =============================================================================

.PHONY: status
status:
	@echo "üìä Development environment status"
	@echo "Container: $(CONTAINER_NAME)"
	@if docker ps --filter "name=$(CONTAINER_NAME)" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -q $(CONTAINER_NAME); then \
		echo "‚úÖ Status: Running"; \
		docker ps --filter "name=$(CONTAINER_NAME)" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"; \
	else \
		echo "‚ùå Status: Not running"; \
	fi
	@echo ""
	@echo "Image: $(IMAGE_NAME)"
	@if docker images --filter "reference=$(IMAGE_NAME)" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" | tail -n +2 | head -1 | grep -q .; then \
		echo "‚úÖ Image: Available"; \
		docker images --filter "reference=$(IMAGE_NAME)" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"; \
	else \
		echo "‚ùå Image: Not built"; \
		echo "üí° Build with: make build"; \
	fi

.PHONY: dev-help
dev-help:
	@echo "üöÄ MixSeek-Core Development Environment Commands"
	@echo ""
	@echo "üèóÔ∏è  Build & Run:"
	@echo "  build              Build development image"
	@echo "  run                Start development container"
	@echo "  stop               Stop development container"
	@echo "  restart            Restart development container"
	@echo "  status             Show container and image status"
	@echo ""
	@echo "üêö Shell Access:"
	@echo "  bash               Connect to container bash shell"
	@echo "  root               Connect as root user"
	@echo "  exec ARG='cmd'     Execute custom command"
	@echo ""
	@echo "üß™ Testing:"
	@echo "  unittest           Run all tests"
	@echo "  only-test ARG=path Run specific test file"
	@echo "  test-watch         Run tests in watch mode"
	@echo ""
	@echo "üîç Code Quality:"
	@echo "  lint               Run code linting (ruff)"
	@echo "  format             Format code (ruff)"
	@echo "  check              Type checking (mypy)"
	@echo "  fix                Auto-fix linting issues"
	@echo ""
	@echo "üêõ Debugging:"
	@echo "  debug ARG=script   Start debug session"
	@echo "  debug-server       Start debug server only"
	@echo ""
	@echo "ü§ñ AI Development Tools:"
	@echo "  claude-code ARG=   Use Claude Code AI assistant"
	@echo "  codex ARG=         Use OpenAI Codex"
	@echo "  gemini ARG=        Use Google Gemini CLI"
	@echo ""
	@echo "üì¶ Package Management:"
	@echo "  install ARG=pkg    Install Python package"
	@echo "  pip-list           List Python packages"
	@echo "  node-list          List Node.js packages"
	@echo ""
	@echo "üîß Development Utilities:"
	@echo "  watch              Start file watcher"
	@echo "  server             Start development HTTP server"
	@echo "  streamlit          Start Streamlit UI server (076-ui)"
	@echo "  jupyter            Start Jupyter notebook"
	@echo "  env-info           Show environment information"
	@echo ""
	@echo "üìñ Examples:"
	@echo "  make build && make run"
	@echo "  make bash"
	@echo "  make unittest"
	@echo "  make claude-code ARG='--help'"
	@echo "  make debug ARG='src/main.py'"

# Default target shows help
help: dev-help

# =============================================================================
# VALIDATION TARGETS
# =============================================================================

.PHONY: validate
validate:
	@echo "üîç Validating development environment setup"
	@echo "Checking Docker daemon..."
	$(call check_docker)
	@echo "Checking environment file..."
	$(call check_env_file,$(ENV))
	@echo "Checking build arguments..."
	$(call validate_build_args)
	@echo "‚úÖ Environment validation completed"