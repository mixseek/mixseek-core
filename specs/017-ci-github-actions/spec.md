# Feature Specification: GitHub Actions CI Pipeline

**Feature Branch**: `102-ci-github-actions`
**Created**: 2025-11-18
**Status**: Draft
**Input**: User description: "次のCIの仕様を定義してください

- GitHub Actionsで実施, runnerはuv https://docs.astral.sh/uv/guides/integration/github/
- developへのPR時
- コードチェック: ruff, mypy
- テスト: pytest, API_KEYを使うテストは除外し、今後検討する
- テストカバレッジ: 将来対応
- セキュリティ強化: 将来対応
- ドキュメントのビルド
- wheelのビルド: 将来対応
- コンテナのビルド: 将来対応

関連: issue#104
https://github.com/AlpacaTechSolution/mixseek-core/issues/104"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Code Quality Verification (Priority: P1)

開発者がdevelopまたはmainブランチに対してプルリクエストを作成すると、コードの品質が自動的に検証される。これにより、レビュワーは品質基準を満たしていることを確認してからレビューに集中できる。

**Why this priority**: コード品質は最も基本的な要件であり、他のすべてのチェックの基礎となる。品質基準を満たさないコードは、テストやビルドの前に検出されるべき。

**Independent Test**: PRを作成し、コード品質チェック(ruff, mypy)が実行され、結果がPRに表示されることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 開発者がdevelopまたはmainブランチへのPRを作成した、**When** CIが実行される、**Then** ruffによるリント・フォーマットチェックが実行され、結果がPRに表示される
2. **Given** 開発者がdevelopまたはmainブランチへのPRを作成した、**When** CIが実行される、**Then** mypyによる型チェックが実行され、結果がPRに表示される
3. **Given** コードにruffまたはmypyのエラーが含まれている、**When** CIが実行される、**Then** チェックが失敗し、具体的なエラー箇所が明示される
4. **Given** コードがすべての品質基準を満たしている、**When** CIが実行される、**Then** チェックが成功し、緑色のチェックマークが表示される

---

### User Story 2 - Automated Testing (Priority: P1)

開発者がPRを作成すると、既存の機能が破壊されていないことを確認するために、すべての自動テストが実行される。API_KEYを必要とするテストは現時点では除外される。

**Why this priority**: 自動テストは回帰の早期検出に不可欠。コード品質と同等に重要な基本的な検証項目。

**Independent Test**: PRを作成し、pytestが実行され、API_KEYを必要としないテストのみが実行されることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 開発者がdevelopまたはmainブランチへのPRを作成した、**When** CIが実行される、**Then** pytestがすべてのユニット・統合テストを実行する
2. **Given** テストにAPI_KEYを必要とするものが含まれる、**When** CIが実行される、**Then** それらのテストは除外され、他のテストのみが実行される
3. **Given** 一部のテストが失敗した、**When** CIが実行される、**Then** 失敗したテストの詳細がPRに表示される
4. **Given** すべてのテストが成功した、**When** CIが実行される、**Then** テストチェックが成功し、緑色のチェックマークが表示される

---

### User Story 3 - Documentation Build Verification (Priority: P2)

開発者がdevelopまたはmainブランチへのPRを作成すると、ドキュメントが正しくビルドできることが検証される。これにより、ドキュメントの構文エラーや壊れたリンクが早期に発見される。

**Why this priority**: ドキュメントは重要だが、コードの動作には直接影響しないため、P1より優先度は低い。ただし、リリース前には必須。

**Independent Test**: PRを作成し、Sphinxドキュメントのビルドが実行され、成功または失敗することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 開発者がdevelopまたはmainブランチへのPRを作成した、**When** CIが実行される、**Then** Sphinxドキュメントビルドが実行される
2. **Given** ドキュメントに構文エラーまたは壊れたリンクがある、**When** CIが実行される、**Then** ビルドが失敗し、具体的なエラーが表示される
3. **Given** ドキュメントがすべて正しい、**When** CIが実行される、**Then** ビルドが成功し、緑色のチェックマークが表示される

---

## Clarifications

### Session 2025-11-18

- Q: CI失敗時のマージブロック動作 - developブランチに対してどのポリシーを適用すべきか? → A: すべての必須チェック(ruff, mypy, pytest, docs)が成功するまでマージを禁止する
- Q: CIタイムアウト制限 - CIジョブの最大実行時間はどれくらいが適切か? → A: 15分
- Q: CI失敗時の再実行ポリシー - CI失敗後の再実行について、どのポリシーを採用すべきか? → A: 開発者が手動でいつでも再実行可能
- Q: CI結果の通知範囲 - CIチェック完了時にどの範囲に通知すべきか? → A: PRの作成者とレビュワーのみ
- Q: CI並行実行数の制限 - 複数のPRが同時に作成された場合のCI並行実行ポリシーは? → A: 制限なし（GitHub Actionsのデフォルト制限に従う）

### Session 2025-11-19

- Q: developとmainの両ブランチに対してCIを実行する場合、チェック内容（ruff, mypy, pytest, docs）は同じにすべきか? → A: 両ブランチで同一のチェック内容を実施する
- Q: mainブランチへのPRに対するマージポリシーは、developブランチと同じく「すべての必須チェック成功までマージ禁止」とすべきか? → A: mainもdevelopと同じポリシー（全チェック成功までマージ禁止）
- Q: CIをトリガーするPRのターゲットブランチは、developとmainの2つに限定すべきか、それともすべてのブランチへのPRで実行すべきか? → A: developとmainの2つに限定
- Q: GitHub Actionsのワークフロー構成は、単一ファイルで全チェックを実行すべきか、それとも各チェックを独立したワークフローファイルに分割すべきか? → A: 単一ワークフローファイル内で複数ジョブとして実行
- Q: CI環境で使用するPythonバージョンは、プロジェクト要件と完全に一致させるべきか? → A: プロジェクトルートの .python-version と同期
- Q: Pythonの複数バージョン（3.13, 3.14など）でのテストは必要か? → A: 将来対応とし、現在は単一バージョンのみサポート

---

### Edge Cases

- 複数の開発者が同時に異なるPRを作成した場合、CIジョブが並列実行され、互いに干渉しないこと
- PRが更新された場合、古いCIジョブがキャンセルされ、最新のコミットに対してのみCIが実行されること
- CIの実行中にネットワークエラーやリソース不足が発生した場合、適切なエラーメッセージが表示され、再実行可能であること
- uvの依存関係のインストールに失敗した場合、明確なエラーメッセージが表示されること
- ドキュメントビルドに必要な依存関係が不足している場合、適切なエラーメッセージが表示されること
- キャッシュが破損または無効な場合でも、CIは正しく依存関係を再インストールして実行を継続すること
- pyproject.tomlまたはuv.lockファイルが変更された場合、キャッシュが無効化され、最新の依存関係がインストールされること

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはdevelopまたはmainブランチへのプルリクエスト作成時に自動的にCIパイプラインをトリガーしなければならない
- **FR-002**: システムはuvを使用して依存関係をインストールしなければならない
- **FR-003**: システムはruffによるコードのリント・フォーマットチェックを実行しなければならない
- **FR-004**: システムはmypyによる静的型チェックを実行しなければならない
- **FR-005**: システムはpytestによる自動テストを実行しなければならない
- **FR-006**: システムはAPI_KEYを必要とするテストを除外しなければならない
- **FR-007**: システムはSphinxを使用してドキュメントをビルドしなければならない
- **FR-008**: システムは各チェック(ruff, mypy, pytest, ドキュメントビルド)の結果をプルリクエストのステータスチェックとして表示しなければならない
- **FR-009**: システムはいずれかのチェックが失敗した場合、プルリクエスト全体のステータスを失敗として表示しなければならない
- **FR-010**: システムはすべてのチェックが成功した場合、プルリクエスト全体のステータスを成功として表示しなければならない
- **FR-011**: システムはCIジョブの実行ログをプルリクエストから閲覧可能にしなければならない
- **FR-012**: システムはPRが更新された際、実行中の古いCIジョブをキャンセルし、最新のコミットに対してのみCIを実行しなければならない
- **FR-013**: システムはすべての必須チェック(ruff, mypy, pytest, ドキュメントビルド)が成功するまで、developまたはmainブランチへのマージを禁止しなければならない
- **FR-014**: システムは開発者がCIジョブを手動でいつでも再実行できる機能を提供しなければならない
- **FR-015**: システムはCIチェック完了時に、PRの作成者とレビュワーに対してGitHub標準の通知機能を使用して通知しなければならない

### Non-Functional Requirements

- **NFR-001**: CIパイプラインは、uvのキャッシング機能を活用し、依存関係のインストール時間を最小化すること
- **NFR-002**: 各チェックは独立して実行され、以下を満たすこと:
  - 1つのチェックの失敗が他のチェックの実行を妨げないこと
  - すべてのチェックの結果が個別にPRステータスとして表示されること
  - いずれかのチェックが失敗しても、他のすべてのチェックは完了まで実行されること
- **NFR-003**: CIの総実行時間は通常5分以内に完了すること(キャッシュが有効な場合)
- **NFR-004**: システムはGitHub Actionsの標準的なログフォーマットを使用し、エラーの原因を容易に特定できるようにすること
- **NFR-005**: CIジョブの最大実行時間は15分とし、この時間を超えた場合は自動的に失敗として扱うこと

### Future Enhancements

以下の機能は将来の実装として検討される:

- 複数のPythonバージョン（3.13, 3.14など）でのマトリックステスト
- テストカバレッジの計測とレポート生成
- セキュリティ脆弱性スキャン(依存関係およびコード)
- wheelパッケージのビルドとアーティファクトの保存
- Dockerコンテナイメージのビルドとレジストリへのプッシュ
- API_KEYを使用するE2Eテストの安全な実行(シークレット管理を含む)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 開発者がdevelopまたはmainブランチへPRを作成してから、すべてのCIチェックが完了するまでの時間が5分以内である(依存関係がキャッシュされている場合)
- **SC-002**: PRに対して4つの独立したステータスチェック(ruff, mypy, pytest, ドキュメントビルド)が個別に表示される
- **SC-003**: コードに品質問題がある場合、95%以上のケースでCIが失敗を検出し、具体的なエラー箇所を明示する
- **SC-004**: PRが更新された場合、古いCIジョブが自動的にキャンセルされ、リソースの無駄遣いが防止される
- **SC-005**: チームメンバーの80%以上が「CIにより品質問題が早期に発見されるようになった」と回答する
- **SC-006**: レビュワーが品質基準を手動で確認する時間が、CI導入前と比較して50%削減される

## Assumptions

- GitHub Actionsのrunnerとして、uvの公式ガイドに従った設定を使用する
- uvのバージョンは最新の安定版を使用する
- ruff, mypy, pytest, Sphinxの設定は既に`pyproject.toml`に定義されている
- API_KEYを必要とするテストは、適切なpytestマーカー(例: `@pytest.mark.requires_api_key`)でマークされている
- ドキュメントビルドに必要な依存関係は`pyproject.toml`の`docs`グループに定義されている
- developおよびmainブランチがCIのターゲットブランチであり、他のブランチ（feature → feature など）へのPRではCIは実行されない
- CI並行実行数はGitHub Actionsのデフォルト制限（組織・リポジトリレベルの設定）に従う
- CIワークフローは単一の`.github/workflows/ci.yml`ファイルとして構成され、各チェック（ruff, mypy, pytest, docs）は独立したジョブとして並列実行される
- CI環境で使用するPythonバージョンは、プロジェクトルートの`.python-version`ファイルから読み取られ、開発環境と完全に同期される

## Dependencies

- GitHub Actionsが利用可能であること
- uvがGitHub Actionsのランナーで利用可能であること(公式ガイドに従った設定)
- プロジェクトのruff, mypy, pytest設定が正しく構成されていること
- Sphinxドキュメントのビルド設定が正しく構成されていること

## Out of Scope

以下はこの機能の対象外:

- リリース時の自動デプロイ（mainブランチへのマージ後のデプロイフロー）
- パフォーマンステストの実行
- クロスプラットフォームテスト(Windows, macOSなど)
- カバレッジレポートの生成とPRへのコメント投稿
- セキュリティスキャンツールの統合
- wheelパッケージのビルドと配布
- Dockerイメージのビルドとプッシュ
- Slackなどの外部サービスへの通知
